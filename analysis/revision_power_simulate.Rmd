---
title: "Power analysis"
author: "XSun"
date: "2025-11-16"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

# Introduction

To evaluate the statistical power of the ECT under reduced GWAS sample sizes, we performed a simulation procedure for some factor-trait pairs.

-   Estimating the true effect size of factor on trait

ECT models the relationship between SNP effects on the factor (exposure) and on the trait (outcome) using a no-intercept regression:

$$
\beta^{\text{GWAS}} = \gamma \cdot \beta^{\text{factor}} + \varepsilon ,
$$

where $\gamma$ represents the causal effect of the factor on the trait.

For each factor--trait pair, we extracted supporting SNPs with $\mathrm{FDR}_{\text{exposure}} < 0.2$ and estimated $\gamma$ by fitting: 

$$
\beta^{\text{GWAS}}_j = \gamma \, \beta^{\text{factor}}_j + \varepsilon_j .
$$ 
The fitted slope $\hat{\gamma}$ was taken as the estimated true effect.

For each SNP $j$, the expected (true) GWAS effect is therefore: 


$$
\beta^{\text{true}}_j = \hat{\gamma} \cdot \beta^{\text{factor}}_j .
$$

-   Simulating down-sampled GWAS effect estimates

Assuming the standard error of a GWAS effect estimate scales with sample size as $SE \propto N^{-1/2}$, a down-sampled GWAS using a proportion $d$ of the original sample has: 

$$
SE^{\text{new}}_j = \frac{SE_j}{\sqrt{d}} .
$$ 

For each supporting SNP, we simulated GWAS estimates under the down-sampled scenario according to: 

$$
\hat{\beta}_j \sim N\!\left(
      \beta^{\text{true}}_j,\ 
      SE^{\text{new}}_j
\right).
$$ 

We generated 100 independent simulations per SNP, yielding 100 complete GWAS-like datasets.

-   Re-running ECT on simulated datasets

For each simulated dataset, we replaced the observed GWAS effect sizes with the simulated values $\hat{\beta}_j$, retained the original exposure effect estimates and $p$-values, and re-ran ECT for the corresponding factor--trait pair.

This procedure produced 100 ECT results, each representing the inference obtained under a GWAS with reduced sample size.

-   Power estimation

Power was estimated as the proportion of simulation rounds in which the ECT result remained statistically significant under the specified down-sampling proportion.


```{r}

suppressMessages(library(ggplot2))
suppressMessages(library(gridExtra))

celltypes <- c("B_cell","CD14_positive_monocyte","CD15_positive_leukocyte","platelet","T_cell","thymocyte")
types <- c("B cell (CD19+)","Monocyte (CD14+)","Granulocyte (CD15+)","Platelet","T cell (CD4+)","T cell (CD8+)")
names(celltypes) <- types
names(types) <- celltypes

```

# Strong examples ECT FDR < 0.1

## Highlighted example 1: NF-kappa B signaling pathway - Platelet - HB-ebi-a-GCST90002384

```{r}

trait="HB-ebi-a-GCST90002384"
factor="04064_PC1"
celltype="platelet"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT


df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```


## Highlighted example 2: Leukocyte transendothelial migration - T cell (CD 8+) - IBD-ebi-a-GCST003043

```{r}

celltype <- "thymocyte"
trait <- "IBD-ebi-a-GCST003043"
factor <- "04670_PC1"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT

df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```




## Top 1: CD15_positive_leukocyte	MCH-ebi-a-GCST90002390	04910_PC4

```{r}

trait="MCH-ebi-a-GCST90002390"
factor="04910_PC4"
celltype="CD15_positive_leukocyte"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT


df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```




## Top 3: platelet	RET-ebi-a-GCST90002405	04390_PC5

```{r}

trait="RET-ebi-a-GCST90002405"
factor="04390_PC5"
celltype="platelet"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT


df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```









## Top 4: platelet	RET-ebi-a-GCST90002405	04714_PC4

```{r}

trait="RET-ebi-a-GCST90002405"
factor="04714_PC4"
celltype="platelet"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT


df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```












## Top 5: platelet	RET-ebi-a-GCST90002405	00230_PC1

```{r}

trait="RET-ebi-a-GCST90002405"
factor="00230_PC1"
celltype="platelet"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT


df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```
















# Weak examples - ECT FDR close to 0.2 

## example 1: B_cell - RBC-ebi-a-GCST90002403 - 04217_PC4

```{r}

celltype <- "B_cell"
trait <- "RBC-ebi-a-GCST90002403"
factor <- "04217_PC4"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT

df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```


## example 2: B_cell - RBC-ebi-a-GCST90002403 - 03040_PC4

```{r}

celltype <- "B_cell"
trait <- "RBC-ebi-a-GCST90002403"
factor <- "03040_PC4"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT

df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```



## example 3: B_cell - MCV-ebi-a-GCST90002392 - 03040_PC4

```{r}

celltype <- "B_cell"
trait <- "MCV-ebi-a-GCST90002392"
factor <- "03040_PC4"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT

df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```








## example 4: B_cell - T1D-ebi-a-GCST90014023 - 00640_PC1

```{r}

celltype <- "B_cell"
trait <- "T1D-ebi-a-GCST90014023"
factor <- "00640_PC1"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT

df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```







## example 5: platelet - RET-ebi-a-GCST90002405 - 04625_PC3

```{r}

celltype <- "platelet"
trait <- "RET-ebi-a-GCST90002405"
factor <- "04625_PC3"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT

df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```








# Random examples 

## example 1: B_cell- MCH-ebi-a-GCST90002390 - 04926_PC4

```{r}

celltype <- "platelet"
trait <- "RET-ebi-a-GCST90002405"
factor <- "04625_PC3"

df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

df$celltype <- types[df$celltype]

dt_pair <- df[df$trait == trait & df$factor == factor,]
p_obs <- dt_pair$p_ECT

df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )

df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

p_cutoff_fdr02 <- max(df_fdr02$p_ECT)

```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=12}

power_all <- c()
p <- list()
for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
#for (downsample_size in c(0.3, 0.5, 0.7, 1)){  
  
  file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
  ECT_res_allround_df<- readRDS(file_power)
  
  tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
  power_all <- rbind(power_all, tmp)
  
  num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
  num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)
  
  p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
    geom_histogram(bins = 30, color = "white", fill = "steelblue") +
    
    # cutoff lines
    geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
    geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +
    
    # stacked annotation block
    annotate(
      "label",
      x = max(-log10(ECT_res_allround_df$p_ECT)),
      y = Inf,
      hjust = 1, vjust = 1.2,
      label = paste0(
        "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
        "Count p <= 0.2 cutoff: ", num_leq_fdr02
      ),
      size = 4,
      fill = "white",
      label.size = 0.3
    ) +
    
    theme_bw(base_size = 13) +
    labs(
      x = "-log10(ECT p-value)",
      y = "Count",
      title = paste0("downsample size ", downsample_size)
    )

  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)
#all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]], nrow = 2)


colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
rownames(power_all) <- NULL

DT::datatable(power_all ,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','power'),options = list(pageLength = 10) )

```








