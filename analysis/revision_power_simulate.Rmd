---
title: "Power analysis"
author: "XSun"
date: "2025-11-16"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

# Introduction

To evaluate the statistical power of the ECT under reduced GWAS sample sizes, we performed a simulation procedure for some factor-trait pairs.

-   Estimating the true effect size of factor on trait

ECT models the relationship between SNP effects on the factor (exposure) and on the trait (outcome) using a no-intercept regression:

$$
\beta^{\text{GWAS}} = \gamma \cdot \beta^{\text{factor}} + \varepsilon ,
$$

where $\gamma$ represents the causal effect of the factor on the trait.

For each factor--trait pair, we extracted supporting SNPs with $\mathrm{FDR}_{\text{exposure}} < 0.2$ and estimated $\gamma$ by fitting: 

$$
\beta^{\text{GWAS}}_j = \gamma \, \beta^{\text{factor}}_j + \varepsilon_j .
$$ 
The fitted slope $\hat{\gamma}$ was taken as the estimated true effect.

For each SNP $j$, the expected (true) GWAS effect is therefore: 


$$
\beta^{\text{true}}_j = \hat{\gamma} \cdot \beta^{\text{factor}}_j .
$$

-   Simulating down-sampled GWAS effect estimates

Assuming the standard error of a GWAS effect estimate scales with sample size as $SE \propto N^{-1/2}$, a down-sampled GWAS using a proportion $d$ of the original sample has: 

$$
SE^{\text{new}}_j = \frac{SE_j}{\sqrt{d}} .
$$ 

For each supporting SNP, we simulated GWAS estimates under the down-sampled scenario according to: 

$$
\hat{\beta}_j \sim N\!\left(
      \beta^{\text{true}}_j,\ 
      SE^{\text{new}}_j
\right).
$$ 

We generated 100 independent simulations per SNP, yielding 100 complete GWAS-like datasets.

-   Re-running ECT on simulated datasets

For each simulated dataset, we replaced the observed GWAS effect sizes with the simulated values $\hat{\beta}_j$, retained the original exposure effect estimates and $p$-values, and re-ran ECT for the corresponding factor--trait pair.

This procedure produced 100 ECT results, each representing the inference obtained under a GWAS with reduced sample size.

-   Power estimation

Power was estimated as the proportion of simulation rounds in which the ECT result remained statistically significant under the specified down-sampling proportion.


```{r}

suppressMessages(library(ggplot2))
suppressMessages(library(gridExtra))
suppressMessages(library(data.table))
suppressMessages(library(DT))
suppressMessages(library(knitr))
suppressMessages(library(htmltools))
library(dplyr)
library(ggplot2)
library(tidyr)

celltypes <- c("B_cell","CD14_positive_monocyte","CD15_positive_leukocyte","platelet","T_cell","thymocyte")
types <- c("B cell (CD19+)","Monocyte (CD14+)","Granulocyte (CD15+)","Platelet","T cell (CD4+)","T cell (CD8+)")
names(celltypes) <- types
names(types) <- celltypes


DT::datatable(matrix())
```


# Summary for strong/weak pairs

## Strong 

```{r, results='asis'}

df_all_fdr01 <- c()
df_all_fdr02 <- c()
for(celltype in celltypes){

  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  df <- df[complete.cases(df$ECT_FDR_5suppSNP),]

  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2 & df$ECT_FDR_5suppSNP > 0.1,]
  df_all_fdr01 <- rbind(df_all_fdr01,df_fdr01)
  df_all_fdr02 <- rbind(df_all_fdr02,df_fdr02)

}

df_all_fdr02 <- df_all_fdr02[order(df_all_fdr02$ECT_FDR_5suppSNP,decreasing = F),]
df_all_fdr01 <- df_all_fdr01[order(df_all_fdr01$ECT_FDR_5suppSNP,decreasing = F),]

```

```{r, results='asis', warning=FALSE, message=FALSE, fig.height=6, fig.width=12}
#for (i in 2:2) {

power_all_pairs <- c()
for (i in 1:nrow(df_all_fdr01)) {  
  trait=df_all_fdr01$trait[i]
  factor=df_all_fdr01$factor[i]
  celltype=df_all_fdr01$celltype[i]

  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

  df$celltype <- types[df$celltype]
  
  dt_pair <- df[df$trait == trait & df$factor == factor,]
  p_obs <- dt_pair$p_ECT
  
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]
  
  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
  p_cutoff_fdr01 <- max(df_fdr01$p_ECT)
  
  p_cutoff_fdr02 <- max(df_fdr02$p_ECT)
  
  power_all <- data.frame(
    celltype = character(),
    factor = character(),
    trait = character(),
    downsample_size = numeric(),
    power_fdr01     = numeric(),
    power_fdr02     = numeric(),
    stringsAsFactors = FALSE
  )
  for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
    
    file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
    ECT_res_allround_df<- readRDS(file_power)
    
    power_all <- rbind(
      power_all,
      data.frame(
        celltype = celltype,
        factor = factor,
        trait = trait,
        downsample_size = downsample_size,
        power_fdr01     = sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01),
        power_fdr02     = sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02)
      )
    )
    

    
  }
  
 
  # colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
  rownames(power_all) <- NULL
  power_all <- as.data.frame(power_all)

  
  power_all_pairs <- rbind(power_all_pairs, power_all)
  
}


power_summary <- power_all_pairs %>%
  group_by(downsample_size) %>%
  summarise(
    mean_fdr01 = mean(power_fdr01, na.rm = TRUE),
    se_fdr01   = sd(power_fdr01, na.rm = TRUE) / sqrt(n()),
    mean_fdr02 = mean(power_fdr02, na.rm = TRUE),
    se_fdr02   = sd(power_fdr02, na.rm = TRUE) / sqrt(n())
  )

# Reshape to long format for ggplot
power_long <- power_summary %>%
  pivot_longer(
    cols = c(mean_fdr01, mean_fdr02, se_fdr01, se_fdr02),
    names_to = c("metric", "fdr"),
    names_pattern = "(mean|se)_(fdr\\d+)",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = metric,
    values_from = value
  )

ggplot(power_long, aes(x = downsample_size, y = mean, color = fdr, group = fdr)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.02) +
  theme_bw(base_size = 14) +
  labs(
    x = "Downsample proportion",
    y = "Mean power",
    color = "FDR cutoff",
    title = "Power vs Downsample Size Across All Strong Pairs"
  )


```

## Weak 


## Summary for weak pairs

```{r, results='asis', warning=FALSE, message=FALSE, fig.height=6, fig.width=12}
#for (i in 2:2) {

power_all_pairs <- c()
for (i in 1:22) {  
  trait=df_all_fdr02$trait[i]
  factor=df_all_fdr02$factor[i]
  celltype=df_all_fdr02$celltype[i]

  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

  df$celltype <- types[df$celltype]
  
  dt_pair <- df[df$trait == trait & df$factor == factor,]
  p_obs <- dt_pair$p_ECT
  
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]
  
  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
  p_cutoff_fdr01 <- max(df_fdr01$p_ECT)
  
  p_cutoff_fdr02 <- max(df_fdr02$p_ECT)
  
  power_all <- data.frame(
    celltype = character(),
    factor = character(),
    trait = character(),
    downsample_size = numeric(),
    power_fdr01     = numeric(),
    power_fdr02     = numeric(),
    stringsAsFactors = FALSE
  )
  for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){
    
    file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
    ECT_res_allround_df<- readRDS(file_power)
    
    power_all <- rbind(
      power_all,
      data.frame(
        celltype = celltype,
        factor = factor,
        trait = trait,
        downsample_size = downsample_size,
        power_fdr01     = sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01),
        power_fdr02     = sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02)
      )
    )
    

    
  }
  
 
  # colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
  rownames(power_all) <- NULL
  power_all <- as.data.frame(power_all)

  
  power_all_pairs <- rbind(power_all_pairs, power_all)
  
}


power_summary <- power_all_pairs %>%
  group_by(downsample_size) %>%
  summarise(
    mean_fdr01 = mean(power_fdr01, na.rm = TRUE),
    se_fdr01   = sd(power_fdr01, na.rm = TRUE) / sqrt(n()),
    mean_fdr02 = mean(power_fdr02, na.rm = TRUE),
    se_fdr02   = sd(power_fdr02, na.rm = TRUE) / sqrt(n())
  )

# Reshape to long format for ggplot
power_long <- power_summary %>%
  pivot_longer(
    cols = c(mean_fdr01, mean_fdr02, se_fdr01, se_fdr02),
    names_to = c("metric", "fdr"),
    names_pattern = "(mean|se)_(fdr\\d+)",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = metric,
    values_from = value
  )

ggplot(power_long, aes(x = downsample_size, y = mean, color = fdr, group = fdr)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.02) +
  theme_bw(base_size = 14) +
  labs(
    x = "Downsample proportion",
    y = "Mean power",
    color = "FDR cutoff",
    title = "Power vs Downsample Size Across All Weak Pairs"
  )


```


# Strong examples ECT FDR < 0.1

```{r, results='asis'}

df_all_fdr01 <- c()
df_all_fdr02 <- c()
for(celltype in celltypes){

  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  df <- df[complete.cases(df$ECT_FDR_5suppSNP),]

  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2 & df$ECT_FDR_5suppSNP > 0.1,]
  df_all_fdr01 <- rbind(df_all_fdr01,df_fdr01)
  df_all_fdr02 <- rbind(df_all_fdr02,df_fdr02)

}

df_all_fdr02 <- df_all_fdr02[order(df_all_fdr02$ECT_FDR_5suppSNP,decreasing = F),]
df_all_fdr01 <- df_all_fdr01[order(df_all_fdr01$ECT_FDR_5suppSNP,decreasing = F),]

```






```{r, results='asis', warning=FALSE, message=FALSE, fig.height=6, fig.width=12}
#for (i in 2:2) {

power_all_pairs <- c()
for (i in 1:nrow(df_all_fdr01)) {
  trait=df_all_fdr01$trait[i]
  factor=df_all_fdr01$factor[i]
  celltype=df_all_fdr01$celltype[i]

  cat(sprintf("<h3 style='margin-top:1px'>Top %d - %s - %s - %s </h3>", i, celltype, factor, trait))

  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

  df$celltype <- types[df$celltype]

  dt_pair <- df[df$trait == trait & df$factor == factor,]
  p_obs <- dt_pair$p_ECT


  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

  htmltools::div(
  style = "margin-top: 30px; margin-bottom: 30px;",
  DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )
)

  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
  p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

  p_cutoff_fdr02 <- max(df_fdr02$p_ECT)


  p <- list()
  power_all <- data.frame(
  downsample_size = numeric(),
  power_fdr01     = numeric(),
  power_fdr02     = numeric(),
  stringsAsFactors = FALSE
)
  for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){

    file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
    ECT_res_allround_df<- readRDS(file_power)

    tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
    # power_all <- rbind(power_all, tmp)

    power_all <- rbind(
      power_all,
      data.frame(
        celltype = celltype,
        factor = factor,
        trait = trait,
        downsample_size = downsample_size,
        power_fdr01     = sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01),
        power_fdr02     = sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02)
      )
    )


    num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
    num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)

    p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
      geom_histogram(bins = 30, color = "white", fill = "steelblue") +

      # cutoff lines
      geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
      geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +

      # stacked annotation block
      annotate(
        "label",
        x = max(-log10(ECT_res_allround_df$p_ECT)),
        y = Inf,
        hjust = 1, vjust = 1.2,
        label = paste0(
          "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
          "Count p <= 0.2 cutoff: ", num_leq_fdr02
        ),
        size = 4,
        fill = "white",
        label.size = 0.3
      ) +

      theme_bw(base_size = 13) +
      labs(
        x = "-log10(ECT p-value)",
        y = "Count",
        title = paste0("downsample size ", downsample_size)
      )


  }

  all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


  colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
  rownames(power_all) <- NULL
  power_all <- as.data.frame(power_all)

  table <- DT::datatable(
    power_all,
    caption = htmltools::tags$caption(
      style = 'caption-side:left; text-align:left; color:black; font-size:140%;',
      paste0("Power for ", celltype, " - ", factor, " - ", trait)
    ),
    options = list(pageLength = 10)
  )

  cat(knit_print(table))

  power_all_pairs <- rbind(power_all_pairs, power_all)

}




```








# Weak examples 0.1 < ECT FDR < 0.2


```{r, results='asis', warning=FALSE, message=FALSE, fig.height=6, fig.width=12}
#for (i in 2:2) {
for (i in 1: 22 ) {

  trait=df_all_fdr02$trait[i]
  factor=df_all_fdr02$factor[i]
  celltype=df_all_fdr02$celltype[i]

  cat(sprintf("<h3 style='margin-top:1px'>Top %d - %s - %s - %s </h3>", i+8, celltype, factor, trait))

  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved_noMHCadded.RDS"))

  df$celltype <- types[df$celltype]

  dt_pair <- df[df$trait == trait & df$factor == factor,]
  p_obs <- dt_pair$p_ECT


  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]

  htmltools::div(
  style = "margin-top: 30px; margin-bottom: 30px;",
  DT::datatable(df_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','pairs with FDR < 0.2'),options = list(pageLength = 5) )
)

  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
  p_cutoff_fdr01 <- max(df_fdr01$p_ECT)

  p_cutoff_fdr02 <- max(df_fdr02$p_ECT)


  p <- list()
  power_all <- data.frame(
  downsample_size = numeric(),
  power_fdr01     = numeric(),
  power_fdr02     = numeric(),
  stringsAsFactors = FALSE
)
  for (downsample_size in c(0.01, 0.05, 0.1, 0.3, 0.5, 0.7, 1)){

    file_power <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/power_res/simulation2/", celltype,"-", factor, "-", trait,"_downsample_",downsample_size,"_simulated.RDS")
    ECT_res_allround_df<- readRDS(file_power)

    tmp <- c(downsample_size, sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01), sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02))
    # power_all <- rbind(power_all, tmp)

    power_all <- rbind(
      power_all,
      data.frame(
        downsample_size = downsample_size,
        power_fdr01     = sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr01),
        power_fdr02     = sum(ECT_res_allround_df$p_ECT < p_cutoff_fdr02)
      )
    )


    num_leq_fdr01 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr01)
    num_leq_fdr02 <- sum(ECT_res_allround_df$p_ECT <= p_cutoff_fdr02)

    p[[as.character(downsample_size)]] <- ggplot(ECT_res_allround_df, aes(x = -log10(p_ECT))) +
      geom_histogram(bins = 30, color = "white", fill = "steelblue") +

      # cutoff lines
      geom_vline(xintercept = -log10(p_cutoff_fdr01), color = "red", size = 1) +
      geom_vline(xintercept = -log10(p_cutoff_fdr02), color = "red", linetype = "dashed", size = 1) +

      # stacked annotation block
      annotate(
        "label",
        x = max(-log10(ECT_res_allround_df$p_ECT)),
        y = Inf,
        hjust = 1, vjust = 1.2,
        label = paste0(
          "Count p <= 0.1 cutoff: ", num_leq_fdr01, "\n",
          "Count p <= 0.2 cutoff: ", num_leq_fdr02
        ),
        size = 4,
        fill = "white",
        label.size = 0.3
      ) +

      theme_bw(base_size = 13) +
      labs(
        x = "-log10(ECT p-value)",
        y = "Count",
        title = paste0("downsample size ", downsample_size)
      )


  }

  all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]],p[[7]], nrow = 2)


  colnames(power_all) <- c("downsample_size", "power_fdr01", "power_fdr02")
  rownames(power_all) <- NULL
  power_all <- as.data.frame(power_all)

  table <- DT::datatable(
    power_all,
    caption = htmltools::tags$caption(
      style = 'caption-side:left; text-align:left; color:black; font-size:140%;',
      paste0("Power for ", celltype, " - ", factor, " - ", trait)
    ),
    options = list(pageLength = 10)
  )

  cat(knit_print(table))


}




```
