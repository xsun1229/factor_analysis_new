---
title: "ECT results"
author: "XSun"
date: "2025-10-10"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true  
---

| Trait                         | Abbr.     |
|-------------------------------|-----------|
| Hemoglobin                    | HB        |   
| Hematocrit                    | HCT       |   
| Mean Corpuscular Volume       | MCV       |   
| Mean Corpuscular Hemoglobin   | MCH       |   
| Platelet count                | PLT       |   
| White blood cell count        | WBC       |   
| Red blood cell count          | RBC       |   
| Crohnâ€™s disease               | CD        |   
| Inflammatory bowel disease    | IBD       |   
| Ulcerative colitis            | UC        |   
| Rheumatoid arthritis          | RA        |   
| Type 1 diabetes               | T1D       |   
| Systemic lupus erythematosus  | SLE       |   
| Celiac disease                | celiac    |   
| Asthma                        | asthma    |   
| Psoriasis                     | Psoriasis |   
| Multiple sclerosis            | MS        |   
| Ankylosing spondylitis        | AS        |   
| LDL cholesterol               | LDL       |   
| Hypertension                  | HT        |   
| Allergy                       | Allergy   |   
| Hashimoto thyroiditis         | HT        |   


```{r warning=F, message=F}

library(tidyverse)
library(ggplot2)

celltypes <- c("B_cell","CD14_positive_monocyte","CD15_positive_leukocyte","platelet","T_cell","thymocyte")
type <- c("B cell (CD19+)","Monocyte (CD14+)","Leukocyte (CD15+)","Platelet","T cell (CD4+)","T cell (CD8+)")
names(type) <- celltypes
names(celltypes) <- type

source("/project/xinhe/xsun/pathway_factor/data_v2/traits_selected.R")

folder_ect <- "/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary/"



```


```{r fig.width=8, fig.height=5}

ECT_summary_MBEadded_all <- c()

for (celltype in celltypes){
  
  ECT_summary_MBEadded <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_poolalltraits_MBE_steiger.RDS"))
  ECT_summary_MBEadded_all <- rbind(ECT_summary_MBEadded_all, ECT_summary_MBEadded)
  
}

ECT_summary_allcelltypes_ACATadded_p0005 <- readRDS(paste0(folder_ect,"ECT_summary_allcelltypes_ACATadded_p0005.RDS"))

```

# Summary for all supp_SNP cutoffs

## 40 genes

### EUR 

```{r fig.width=8, fig.height=5}

df_all_FDR01 <- c()
df_all_FDR02 <- c()
df_p0001 <- c()
for (celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_40genes_EUR.RDS"))
  
  tmp_FDR01 <- c(unique(df$celltype),sum(df$FDR_3suppSNP < 0.1,na.rm = T),sum(df$FDR_4suppSNP < 0.1,na.rm = T),sum(df$FDR_5suppSNP < 0.1,na.rm = T),sum(df$FDR_6suppSNP < 0.1,na.rm = T),
                 sum(df$FDR_7suppSNP < 0.1,na.rm = T),sum(df$FDR_8suppSNP < 0.1,na.rm = T),sum(df$FDR_9suppSNP < 0.1,na.rm = T),sum(df$FDR_10suppSNP < 0.1,na.rm = T))
  tmp_FDR02 <- c(unique(df$celltype),sum(df$FDR_3suppSNP < 0.2,na.rm = T),sum(df$FDR_4suppSNP < 0.2,na.rm = T),sum(df$FDR_5suppSNP < 0.2,na.rm = T),sum(df$FDR_6suppSNP < 0.2,na.rm = T),
                 sum(df$FDR_7suppSNP < 0.2,na.rm = T),sum(df$FDR_8suppSNP < 0.2,na.rm = T),sum(df$FDR_9suppSNP < 0.2,na.rm = T),sum(df$FDR_10suppSNP < 0.2,na.rm = T))
  tmp_FDR02[2:length(tmp_FDR02)] <- as.numeric(tmp_FDR02[2:length(tmp_FDR02)]) - as.numeric(tmp_FDR01[2:length(tmp_FDR01)])
  
  df_all_FDR01 <- rbind(df_all_FDR01,tmp_FDR01)
  df_all_FDR02 <- rbind(df_all_FDR02,tmp_FDR02)
  
  df_p0001 <- rbind(df_p0001, df[df$p_ECT < 0.001,])
  
}

df_p0001 <- df_p0001[complete.cases(df_p0001$p_ECT),]

rownames(df_all_FDR01) <- NULL
colnames(df_all_FDR01) <- c("celltype","num_pairs_FDR01_3suppSNP","num_pairs_FDR01_4suppSNP","num_pairs_FDR01_5suppSNP",
                            "num_pairs_FDR01_6suppSNP","num_pairs_FDR01_7suppSNP","num_pairs_FDR01_8suppSNP",
                            "num_pairs_FDR01_9suppSNP","num_pairs_FDR01_10suppSNP")
df_all_FDR01 <- as.data.frame(df_all_FDR01, stringsAsFactors = FALSE)
df_all_FDR01 <- df_all_FDR01 %>% mutate(across(-celltype, as.numeric))

df_long <- df_all_FDR01 %>%
  pivot_longer(
    cols = starts_with("num_pairs_FDR01_"),
    names_to = "num_suppSNP",
    values_to = "num_pairs"
  ) %>%
  mutate(
    num_suppSNP = as.numeric(gsub("num_pairs_FDR01_|suppSNP", "", num_suppSNP))
  )


ggplot(df_long, aes(x = celltype, y = num_pairs, fill = factor(num_suppSNP))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    x = "Cell type",
    y = "Number of pairs (FDR < 0.1)",
    fill = "Supporting SNPs"
  ) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )



rownames(df_all_FDR02) <- NULL
colnames(df_all_FDR02) <- c("celltype","num_pairs_FDR02_3suppSNP","num_pairs_FDR02_4suppSNP","num_pairs_FDR02_5suppSNP",
                            "num_pairs_FDR02_6suppSNP","num_pairs_FDR02_7suppSNP","num_pairs_FDR02_8suppSNP",
                            "num_pairs_FDR02_9suppSNP","num_pairs_FDR02_10suppSNP")
df_all_FDR02 <- as.data.frame(df_all_FDR02, stringsAsFactors = FALSE)
df_all_FDR02 <- df_all_FDR02 %>% mutate(across(-celltype, as.numeric))


df_long <- df_all_FDR02 %>%
  pivot_longer(
    cols = starts_with("num_pairs_FDR02_"),
    names_to = "num_suppSNP",
    values_to = "num_pairs"
  ) %>%
  mutate(
    num_suppSNP = as.numeric(gsub("num_pairs_FDR02_|suppSNP", "", num_suppSNP))
  )


ggplot(df_long, aes(x = celltype, y = num_pairs, fill = factor(num_suppSNP))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    x = "Cell type",
    y = "Number of pairs (FDR < 0.2)",
    fill = "Supporting SNPs"
  ) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )


DT::datatable(df_p0001,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs '),options = list(pageLength = 10) )



```


### EAS

```{r fig.width=8, fig.height=5}

df_all_FDR01 <- c()
df_all_FDR02 <- c()
df_p0001 <- c()
for (celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_40genes_EAS.RDS"))
  
  tmp_FDR01 <- c(unique(df$celltype),sum(df$FDR_3suppSNP < 0.1,na.rm = T),sum(df$FDR_4suppSNP < 0.1,na.rm = T),sum(df$FDR_5suppSNP < 0.1,na.rm = T),sum(df$FDR_6suppSNP < 0.1,na.rm = T),
                 sum(df$FDR_7suppSNP < 0.1,na.rm = T),sum(df$FDR_8suppSNP < 0.1,na.rm = T),sum(df$FDR_9suppSNP < 0.1,na.rm = T),sum(df$FDR_10suppSNP < 0.1,na.rm = T))
  tmp_FDR02 <- c(unique(df$celltype),sum(df$FDR_3suppSNP < 0.2,na.rm = T),sum(df$FDR_4suppSNP < 0.2,na.rm = T),sum(df$FDR_5suppSNP < 0.2,na.rm = T),sum(df$FDR_6suppSNP < 0.2,na.rm = T),
                 sum(df$FDR_7suppSNP < 0.2,na.rm = T),sum(df$FDR_8suppSNP < 0.2,na.rm = T),sum(df$FDR_9suppSNP < 0.2,na.rm = T),sum(df$FDR_10suppSNP < 0.2,na.rm = T))
  tmp_FDR02[2:length(tmp_FDR02)] <- as.numeric(tmp_FDR02[2:length(tmp_FDR02)]) - as.numeric(tmp_FDR01[2:length(tmp_FDR01)])
  
  df_all_FDR01 <- rbind(df_all_FDR01,tmp_FDR01)
  df_all_FDR02 <- rbind(df_all_FDR02,tmp_FDR02)
  
  df_p0001 <- rbind(df_p0001, df[df$p_ECT < 0.001,])
  
}

df_p0001 <- df_p0001[complete.cases(df_p0001$p_ECT),]

rownames(df_all_FDR01) <- NULL
colnames(df_all_FDR01) <- c("celltype","num_pairs_FDR01_3suppSNP","num_pairs_FDR01_4suppSNP","num_pairs_FDR01_5suppSNP",
                            "num_pairs_FDR01_6suppSNP","num_pairs_FDR01_7suppSNP","num_pairs_FDR01_8suppSNP",
                            "num_pairs_FDR01_9suppSNP","num_pairs_FDR01_10suppSNP")
df_all_FDR01 <- as.data.frame(df_all_FDR01, stringsAsFactors = FALSE)
df_all_FDR01 <- df_all_FDR01 %>% mutate(across(-celltype, as.numeric))

df_long <- df_all_FDR01 %>%
  pivot_longer(
    cols = starts_with("num_pairs_FDR01_"),
    names_to = "num_suppSNP",
    values_to = "num_pairs"
  ) %>%
  mutate(
    num_suppSNP = as.numeric(gsub("num_pairs_FDR01_|suppSNP", "", num_suppSNP))
  )


ggplot(df_long, aes(x = celltype, y = num_pairs, fill = factor(num_suppSNP))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    x = "Cell type",
    y = "Number of pairs (FDR < 0.1)",
    fill = "Supporting SNPs"
  ) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )



rownames(df_all_FDR02) <- NULL
colnames(df_all_FDR02) <- c("celltype","num_pairs_FDR02_3suppSNP","num_pairs_FDR02_4suppSNP","num_pairs_FDR02_5suppSNP",
                            "num_pairs_FDR02_6suppSNP","num_pairs_FDR02_7suppSNP","num_pairs_FDR02_8suppSNP",
                            "num_pairs_FDR02_9suppSNP","num_pairs_FDR02_10suppSNP")
df_all_FDR02 <- as.data.frame(df_all_FDR02, stringsAsFactors = FALSE)
df_all_FDR02 <- df_all_FDR02 %>% mutate(across(-celltype, as.numeric))


df_long <- df_all_FDR02 %>%
  pivot_longer(
    cols = starts_with("num_pairs_FDR02_"),
    names_to = "num_suppSNP",
    values_to = "num_pairs"
  ) %>%
  mutate(
    num_suppSNP = as.numeric(gsub("num_pairs_FDR02_|suppSNP", "", num_suppSNP))
  )


ggplot(df_long, aes(x = celltype, y = num_pairs, fill = factor(num_suppSNP))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    x = "Cell type",
    y = "Number of pairs (FDR < 0.2)",
    fill = "Supporting SNPs"
  ) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )


DT::datatable(df_p0001,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs '),options = list(pageLength = 10) )



```



## 20 genes

### EUR 

```{r fig.width=8, fig.height=5}

df_all_FDR01 <- c()
df_all_FDR02 <- c()
df_p0001 <- c()
for (celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_20genes_EUR.RDS"))
  
  tmp_FDR01 <- c(unique(df$celltype),sum(df$FDR_3suppSNP < 0.1,na.rm = T),sum(df$FDR_4suppSNP < 0.1,na.rm = T),sum(df$FDR_5suppSNP < 0.1,na.rm = T),sum(df$FDR_6suppSNP < 0.1,na.rm = T),
                 sum(df$FDR_7suppSNP < 0.1,na.rm = T),sum(df$FDR_8suppSNP < 0.1,na.rm = T),sum(df$FDR_9suppSNP < 0.1,na.rm = T),sum(df$FDR_10suppSNP < 0.1,na.rm = T))
  tmp_FDR02 <- c(unique(df$celltype),sum(df$FDR_3suppSNP < 0.2,na.rm = T),sum(df$FDR_4suppSNP < 0.2,na.rm = T),sum(df$FDR_5suppSNP < 0.2,na.rm = T),sum(df$FDR_6suppSNP < 0.2,na.rm = T),
                 sum(df$FDR_7suppSNP < 0.2,na.rm = T),sum(df$FDR_8suppSNP < 0.2,na.rm = T),sum(df$FDR_9suppSNP < 0.2,na.rm = T),sum(df$FDR_10suppSNP < 0.2,na.rm = T))
  tmp_FDR02[2:length(tmp_FDR02)] <- as.numeric(tmp_FDR02[2:length(tmp_FDR02)]) - as.numeric(tmp_FDR01[2:length(tmp_FDR01)])
  
  df_all_FDR01 <- rbind(df_all_FDR01,tmp_FDR01)
  df_all_FDR02 <- rbind(df_all_FDR02,tmp_FDR02)
  
  df_p0001 <- rbind(df_p0001, df[df$p_ECT < 0.001,])
  
}

df_p0001 <- df_p0001[complete.cases(df_p0001$p_ECT),]

rownames(df_all_FDR01) <- NULL
colnames(df_all_FDR01) <- c("celltype","num_pairs_FDR01_3suppSNP","num_pairs_FDR01_4suppSNP","num_pairs_FDR01_5suppSNP",
                            "num_pairs_FDR01_6suppSNP","num_pairs_FDR01_7suppSNP","num_pairs_FDR01_8suppSNP",
                            "num_pairs_FDR01_9suppSNP","num_pairs_FDR01_10suppSNP")
df_all_FDR01 <- as.data.frame(df_all_FDR01, stringsAsFactors = FALSE)
df_all_FDR01 <- df_all_FDR01 %>% mutate(across(-celltype, as.numeric))

df_long <- df_all_FDR01 %>%
  pivot_longer(
    cols = starts_with("num_pairs_FDR01_"),
    names_to = "num_suppSNP",
    values_to = "num_pairs"
  ) %>%
  mutate(
    num_suppSNP = as.numeric(gsub("num_pairs_FDR01_|suppSNP", "", num_suppSNP))
  )


ggplot(df_long, aes(x = celltype, y = num_pairs, fill = factor(num_suppSNP))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    x = "Cell type",
    y = "Number of pairs (FDR < 0.1)",
    fill = "Supporting SNPs"
  ) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )



rownames(df_all_FDR02) <- NULL
colnames(df_all_FDR02) <- c("celltype","num_pairs_FDR02_3suppSNP","num_pairs_FDR02_4suppSNP","num_pairs_FDR02_5suppSNP",
                            "num_pairs_FDR02_6suppSNP","num_pairs_FDR02_7suppSNP","num_pairs_FDR02_8suppSNP",
                            "num_pairs_FDR02_9suppSNP","num_pairs_FDR02_10suppSNP")
df_all_FDR02 <- as.data.frame(df_all_FDR02, stringsAsFactors = FALSE)
df_all_FDR02 <- df_all_FDR02 %>% mutate(across(-celltype, as.numeric))


df_long <- df_all_FDR02 %>%
  pivot_longer(
    cols = starts_with("num_pairs_FDR02_"),
    names_to = "num_suppSNP",
    values_to = "num_pairs"
  ) %>%
  mutate(
    num_suppSNP = as.numeric(gsub("num_pairs_FDR02_|suppSNP", "", num_suppSNP))
  )


ggplot(df_long, aes(x = celltype, y = num_pairs, fill = factor(num_suppSNP))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    x = "Cell type",
    y = "Number of pairs (FDR < 0.2)",
    fill = "Supporting SNPs"
  ) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )


DT::datatable(df_p0001,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs '),options = list(pageLength = 10) )



```


### EAS

```{r fig.width=8, fig.height=5}

df_all_FDR01 <- c()
df_all_FDR02 <- c()
df_p0001 <- c()
for (celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_20genes_EAS.RDS"))
  
  tmp_FDR01 <- c(unique(df$celltype),sum(df$FDR_3suppSNP < 0.1,na.rm = T),sum(df$FDR_4suppSNP < 0.1,na.rm = T),sum(df$FDR_5suppSNP < 0.1,na.rm = T),sum(df$FDR_6suppSNP < 0.1,na.rm = T),
                 sum(df$FDR_7suppSNP < 0.1,na.rm = T),sum(df$FDR_8suppSNP < 0.1,na.rm = T),sum(df$FDR_9suppSNP < 0.1,na.rm = T),sum(df$FDR_10suppSNP < 0.1,na.rm = T))
  tmp_FDR02 <- c(unique(df$celltype),sum(df$FDR_3suppSNP < 0.2,na.rm = T),sum(df$FDR_4suppSNP < 0.2,na.rm = T),sum(df$FDR_5suppSNP < 0.2,na.rm = T),sum(df$FDR_6suppSNP < 0.2,na.rm = T),
                 sum(df$FDR_7suppSNP < 0.2,na.rm = T),sum(df$FDR_8suppSNP < 0.2,na.rm = T),sum(df$FDR_9suppSNP < 0.2,na.rm = T),sum(df$FDR_10suppSNP < 0.2,na.rm = T))
  tmp_FDR02[2:length(tmp_FDR02)] <- as.numeric(tmp_FDR02[2:length(tmp_FDR02)]) - as.numeric(tmp_FDR01[2:length(tmp_FDR01)])
  
  df_all_FDR01 <- rbind(df_all_FDR01,tmp_FDR01)
  df_all_FDR02 <- rbind(df_all_FDR02,tmp_FDR02)
  
  df_p0001 <- rbind(df_p0001, df[df$p_ECT < 0.001,])
  
}

df_p0001 <- df_p0001[complete.cases(df_p0001$p_ECT),]

rownames(df_all_FDR01) <- NULL
colnames(df_all_FDR01) <- c("celltype","num_pairs_FDR01_3suppSNP","num_pairs_FDR01_4suppSNP","num_pairs_FDR01_5suppSNP",
                            "num_pairs_FDR01_6suppSNP","num_pairs_FDR01_7suppSNP","num_pairs_FDR01_8suppSNP",
                            "num_pairs_FDR01_9suppSNP","num_pairs_FDR01_10suppSNP")
df_all_FDR01 <- as.data.frame(df_all_FDR01, stringsAsFactors = FALSE)
df_all_FDR01 <- df_all_FDR01 %>% mutate(across(-celltype, as.numeric))

df_long <- df_all_FDR01 %>%
  pivot_longer(
    cols = starts_with("num_pairs_FDR01_"),
    names_to = "num_suppSNP",
    values_to = "num_pairs"
  ) %>%
  mutate(
    num_suppSNP = as.numeric(gsub("num_pairs_FDR01_|suppSNP", "", num_suppSNP))
  )


ggplot(df_long, aes(x = celltype, y = num_pairs, fill = factor(num_suppSNP))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    x = "Cell type",
    y = "Number of pairs (FDR < 0.1)",
    fill = "Supporting SNPs"
  ) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )



rownames(df_all_FDR02) <- NULL
colnames(df_all_FDR02) <- c("celltype","num_pairs_FDR02_3suppSNP","num_pairs_FDR02_4suppSNP","num_pairs_FDR02_5suppSNP",
                            "num_pairs_FDR02_6suppSNP","num_pairs_FDR02_7suppSNP","num_pairs_FDR02_8suppSNP",
                            "num_pairs_FDR02_9suppSNP","num_pairs_FDR02_10suppSNP")
df_all_FDR02 <- as.data.frame(df_all_FDR02, stringsAsFactors = FALSE)
df_all_FDR02 <- df_all_FDR02 %>% mutate(across(-celltype, as.numeric))


df_long <- df_all_FDR02 %>%
  pivot_longer(
    cols = starts_with("num_pairs_FDR02_"),
    names_to = "num_suppSNP",
    values_to = "num_pairs"
  ) %>%
  mutate(
    num_suppSNP = as.numeric(gsub("num_pairs_FDR02_|suppSNP", "", num_suppSNP))
  )


ggplot(df_long, aes(x = celltype, y = num_pairs, fill = factor(num_suppSNP))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  labs(
    x = "Cell type",
    y = "Number of pairs (FDR < 0.2)",
    fill = "Supporting SNPs"
  ) +
  theme_bw(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )


DT::datatable(df_p0001,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs '),options = list(pageLength = 10) )



```





# Pathway function summary 

https://uchicago.box.com/s/45robkocp45e63nfvuev8pc47f8hyi6t



# Results for EUR

## Number of supp_SNP >=3

### 40 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_40genes_EUR.RDS"))
  df_fdr02_3snp <- df[df$FDR_3suppSNP < 0.2,]
  df_fdr02_3snp <- df_fdr02_3snp[complete.cases(df_fdr02_3snp$FDR_3suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_3snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_3suppSNP")]
df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_3suppSNP, decreasing = F),]

df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```

### 20 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_20genes_EUR.RDS"))
  df_fdr02_3snp <- df[df$FDR_3suppSNP < 0.2,]
  df_fdr02_3snp <- df_fdr02_3snp[complete.cases(df_fdr02_3snp$FDR_3suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_3snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_3suppSNP")]

df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_3suppSNP, decreasing = F),]


df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```





## Number of supp_SNP >=5

### 40 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_40genes_EUR.RDS"))
  df_fdr02_5snp <- df[df$FDR_5suppSNP < 0.2,]
  df_fdr02_5snp <- df_fdr02_5snp[complete.cases(df_fdr02_5snp$FDR_5suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_5snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_5suppSNP")]
df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_5suppSNP, decreasing = F),]

df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```

### 20 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_20genes_EUR.RDS"))
  df_fdr02_5snp <- df[df$FDR_5suppSNP < 0.2,]
  df_fdr02_5snp <- df_fdr02_5snp[complete.cases(df_fdr02_5snp$FDR_5suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_5snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_5suppSNP")]

df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_5suppSNP, decreasing = F),]


df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```




## Number of supp_SNP >=10

### 40 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_40genes_EUR.RDS"))
  df_fdr02_10snp <- df[df$FDR_10suppSNP < 0.2,]
  df_fdr02_10snp <- df_fdr02_10snp[complete.cases(df_fdr02_10snp$FDR_10suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_10snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_10suppSNP")]
df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_10suppSNP, decreasing = F),]

df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```

### 20 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_20genes_EUR.RDS"))
  df_fdr02_10snp <- df[df$FDR_10suppSNP < 0.2,]
  df_fdr02_10snp <- df_fdr02_10snp[complete.cases(df_fdr02_10snp$FDR_10suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_10snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_10suppSNP")]

df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_10suppSNP, decreasing = F),]


df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```










# Results for EAS

## Number of supp_SNP >=3

### 40 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_40genes_EAS.RDS"))
  df_fdr02_3snp <- df[df$FDR_3suppSNP < 0.2,]
  df_fdr02_3snp <- df_fdr02_3snp[complete.cases(df_fdr02_3snp$FDR_3suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_3snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_3suppSNP")]
df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_3suppSNP, decreasing = F),]

df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```

### 20 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_20genes_EAS.RDS"))
  df_fdr02_3snp <- df[df$FDR_3suppSNP < 0.2,]
  df_fdr02_3snp <- df_fdr02_3snp[complete.cases(df_fdr02_3snp$FDR_3suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_3snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_3suppSNP")]

df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_3suppSNP, decreasing = F),]


df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```





## Number of supp_SNP >=5

### 40 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_40genes_EAS.RDS"))
  df_fdr02_5snp <- df[df$FDR_5suppSNP < 0.2,]
  df_fdr02_5snp <- df_fdr02_5snp[complete.cases(df_fdr02_5snp$FDR_5suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_5snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_5suppSNP")]
df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_5suppSNP, decreasing = F),]

df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```

### 20 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_20genes_EAS.RDS"))
  df_fdr02_5snp <- df[df$FDR_5suppSNP < 0.2,]
  df_fdr02_5snp <- df_fdr02_5snp[complete.cases(df_fdr02_5snp$FDR_5suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_5snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_5suppSNP")]

df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_5suppSNP, decreasing = F),]


df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```




## Number of supp_SNP >=10

### 40 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_40genes_EAS.RDS"))
  df_fdr02_10snp <- df[df$FDR_10suppSNP < 0.2,]
  df_fdr02_10snp <- df_fdr02_10snp[complete.cases(df_fdr02_10snp$FDR_10suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_10snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_10suppSNP")]
df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_10suppSNP, decreasing = F),]

df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```

### 20 genes

```{r fig.width=8, fig.height=5}

df_all_FDR02 <- c()
for (celltype in celltypes){

  df <- readRDS(paste0(folder_ect,celltype,"_ECT_summary_20genes_EAS.RDS"))
  df_fdr02_10snp <- df[df$FDR_10suppSNP < 0.2,]
  df_fdr02_10snp <- df_fdr02_10snp[complete.cases(df_fdr02_10snp$FDR_10suppSNP),]

  df_all_FDR02 <- rbind(df_all_FDR02,df_fdr02_10snp)
}

df_all_FDR02 <-  df_all_FDR02[c("celltype","trait","factor","pathwayID","pathwayName","num_supp_SNP", "p_ECT" ,
                                "n_genes_inpathway","n_genes_expressed","FDR_10suppSNP")]

df_all_FDR02 <- df_all_FDR02[order(df_all_FDR02$FDR_10suppSNP, decreasing = F),]


df_all_FDR02$celltype <- celltypes[df_all_FDR02$celltype]
df_all_FDR02_merged <- merge(
  df_all_FDR02,
  ECT_summary_MBEadded_all[, c("celltype", "trait", "factor", "pathwayID", "mbe_reverse_pair",
                                               "mbe_pval_reverse_pair")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)
df_all_FDR02_merged <- merge(
  df_all_FDR02_merged,
  ECT_summary_allcelltypes_ACATadded_p0005[, c("celltype", "trait", "factor", "pathwayID", "acat_p",
                                               "acat_p_MHCremoved", "acat_p_correct_pairnull",
                                               "acat_p_correct_noMHC_pairnull", "acat_p_correct_traitnull",
                                               "acat_p_correct_noMHC_traitnull", "acat_p_correct_globalnull",
                                               "acat_p_correct_noMHC_globalnull")],
  by = c("celltype", "trait", "factor", "pathwayID"),
  all.x = TRUE
)


DT::datatable(df_all_FDR02_merged,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','significant pairs at FDR < 0.2 (Supp SNP >=3)'),options = list(pageLength = 10) )

df_all_FDR02_merged$mbe_pval_reverse_pair_num <- suppressWarnings(
  as.numeric(df_all_FDR02_merged$mbe_pval_reverse_pair)
)
df_all_FDR02_merged <- df_all_FDR02_merged[complete.cases(df_all_FDR02_merged$mbe_pval_reverse_pair_num),]

# Plot histogram
ggplot(df_all_FDR02_merged, aes(x = mbe_pval_reverse_pair_num)) +
  geom_histogram(binwidth = 0.05, fill = "steelblue", color = "white", boundary = 0) +
  scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
  theme_minimal(base_size = 14) +
  labs(
    x = "MBE reverse pair p-value",
    y = "Count",
    title = "Distribution of MBE p-values"
  )

```







