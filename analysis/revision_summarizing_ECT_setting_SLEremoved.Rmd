---
title: "Summarizing ECT results -- ≥ 5 supporting SNPs & ≥ 20 genes, SLE removed"
author: "XSun"
date: "2025-11-06"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

We applied cutoffs of 
+
- `supporting SNP ≥ 5` and 
- `gene number in pathway ≥ 20` 

to filter the pairs before performing FDR control. All results presented below are based on this setting.


```{r warning=F, message=F}
library(dplyr)
library(ggplot2)
library(gridExtra)
library(forcats)
library(tidyr)

library(ensembldb)
library(EnsDb.Hsapiens.v75)
library(ggrepel)
library(ggrastr)

celltypes <- c("B_cell","CD14_positive_monocyte","CD15_positive_leukocyte","platelet","T_cell","thymocyte")
types <- c("B cell (CD19+)","Monocyte (CD14+)","Leukocyte (CD15+)","Platelet","T cell (CD4+)","T cell (CD8+)")
names(celltypes) <- types
names(types) <- celltypes

folder_ect_summary <- "/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/"

```


# EUR

## Detailed results for all pairs at ECT FDR < 0.2

```{r fig.height=3, fig.width=9, warning=F, message=F}

df_all_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  df <- df[complete.cases(df$ECT_FDR_5suppSNP),]
  
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
  df_all_fdr02 <- rbind(df_all_fdr02,df_fdr02)
  
}


df_all_fdr02$celltype <- types[df_all_fdr02$celltype]
df_all_fdr02 <- df_all_fdr02[order(df_all_fdr02$ECT_FDR_5suppSNP),]

df_all_fdr01 <- df_all_fdr02[df_all_fdr02$ECT_FDR_5suppSNP < 0.1,]

DT::datatable(df_all_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Pairs with ECT FDR <= 0.2 '),options = list(pageLength = 10) )

```


## Number of significant pairs at different cutoffs, for each trait

### ECT FDR < 0.1

```{r fig.height=6, fig.width=12, warning=F, message=F}

FDRcutoff <- 0.1
MBEcutoff <- 0.05

p <- list()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  df_summary <- df %>%
    group_by(trait) %>%
    summarise(
      n_sig_FDR_3suppSNP = sum(ECT_FDR_5suppSNP < FDRcutoff, na.rm = TRUE)
    ) %>%
    arrange(desc(n_sig_FDR_3suppSNP))
  
  df_summary$trait[df_summary$trait =="asthma_pmid36778051"] <- "asthma-pmid36778051"
  
  df_summary <- df_summary %>%
    mutate(trait_simple = sub("-.*", "", trait))
  
  p[[celltype]] <- ggplot(df_summary, aes(x = reorder(trait_simple, -n_sig_FDR_3suppSNP),
                       y = n_sig_FDR_3suppSNP,
                       fill = n_sig_FDR_3suppSNP)) +
  geom_bar(stat = "identity", width = 0.7, color = "black") +
  scale_fill_gradient(low = "lightblue", high = "steelblue") +
  labs(
    x = "Trait",
    y = paste0("# of pairs at FDR < ", FDRcutoff),
    title = types[celltype]
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, size = 10, color = "black"),
    axis.text.y = element_text(size = 10, color = "black"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]], nrow = 2)

p <- list()
for (celltype in celltypes) {
  
  df <- readRDS(paste0(folder_ect_summary, celltype, "_ECT_summary_EUR_SLEremoved.RDS"))
  
  # Convert mbe_pval_reverse_pair to numeric if it’s stored as character
  df <- df %>%
    mutate(mbe_pval_reverse_pair = suppressWarnings(as.numeric(mbe_pval_reverse_pair)))
  
  # Keep only FDR-significant pairs
  df_sig <- df %>%
    dplyr::filter(ECT_FDR_5suppSNP < FDRcutoff)
  
  # Fix naming if needed
  df_sig$trait[df_sig$trait == "asthma_pmid36778051"] <- "asthma-pmid36778051"
  
  # Summarize counts per trait
  df_summary <- df_sig %>%
    group_by(trait) %>%
    summarise(
      n_sig_pairs = n(),
      n_mbe_sig = sum(!is.na(mbe_pval_reverse_pair) & mbe_pval_reverse_pair < MBEcutoff)
    ) %>%
    # Keep traits with at least one FDR-significant pair
    dplyr::filter(n_sig_pairs >= 1) %>%
    mutate(
      trait_simple = sub("-.*", "", trait)
    ) %>%
    arrange(desc(n_sig_pairs))
  
  
  p[[celltype]] <- ggplot(df_summary, aes(x = reorder(trait_simple, -n_sig_pairs))) +
    geom_bar(aes(y = n_sig_pairs), stat = "identity", fill = "grey80", color = "black", width = 0.7) +
    geom_bar(aes(y = n_mbe_sig), stat = "identity", fill = "darkturquoise", width = 0.7) +
    geom_text(aes(y = n_mbe_sig, label = n_mbe_sig), vjust = -0.4, size = 3.5) +
    labs(
      x = "Trait",
      y = paste0("# of FDR<", FDRcutoff, " (blue: MBE p<", MBEcutoff, ")"),
      title = types[celltype]
    ) +
    theme_bw(base_size = 14) +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 90, hjust = 0, size = 10, color = "black"),
      axis.text.y = element_text(size = 10, color = "black"),
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
    )
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]], nrow = 2, top = "Number of pairs with MBE p < 0.05, for the sig pairs")
```



### ECT FDR < 0.2

```{r fig.height=6, fig.width=12, warning=F, message=F}

FDRcutoff <- 0.2
MBEcutoff <- 0.05

p <- list()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  df_summary <- df %>%
    group_by(trait) %>%
    summarise(
      n_sig_FDR_3suppSNP = sum(ECT_FDR_5suppSNP < FDRcutoff, na.rm = TRUE)
    ) %>%
    arrange(desc(n_sig_FDR_3suppSNP))
  
  df_summary$trait[df_summary$trait =="asthma_pmid36778051"] <- "asthma-pmid36778051"
  
  df_summary <- df_summary %>%
    mutate(trait_simple = sub("-.*", "", trait))
  
  p[[celltype]] <- ggplot(df_summary, aes(x = reorder(trait_simple, -n_sig_FDR_3suppSNP),
                       y = n_sig_FDR_3suppSNP,
                       fill = n_sig_FDR_3suppSNP)) +
  geom_bar(stat = "identity", width = 0.7, color = "black") +
  scale_fill_gradient(low = "lightblue", high = "steelblue") +
  labs(
    x = "Trait",
    y = paste0("# of pairs at FDR < ", FDRcutoff),
    title = types[celltype]
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, size = 10, color = "black"),
    axis.text.y = element_text(size = 10, color = "black"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]], nrow = 2)

p <- list()
for (celltype in celltypes) {
  
  df <- readRDS(paste0(folder_ect_summary, celltype, "_ECT_summary_EUR_SLEremoved.RDS"))
  
  # Convert mbe_pval_reverse_pair to numeric if it’s stored as character
  df <- df %>%
    mutate(mbe_pval_reverse_pair = suppressWarnings(as.numeric(mbe_pval_reverse_pair)))
  
  # Keep only FDR-significant pairs
  df_sig <- df %>%
    dplyr::filter(ECT_FDR_5suppSNP < FDRcutoff)
  
    # Fix naming if needed
  df_sig$trait[df_sig$trait == "asthma_pmid36778051"] <- "asthma-pmid36778051"
  
  # Summarize counts per trait
  df_summary <- df_sig %>%
    group_by(trait) %>%
    summarise(
      n_sig_pairs = n(),
      n_mbe_sig = sum(!is.na(mbe_pval_reverse_pair) & mbe_pval_reverse_pair < MBEcutoff)
    ) %>%
    # Keep traits with at least one FDR-significant pair
    dplyr::filter(n_sig_pairs >= 1) %>%
    mutate(
      trait_simple = sub("-.*", "", trait)
    ) %>%
    arrange(desc(n_sig_pairs))
  

  
  p[[celltype]] <- ggplot(df_summary, aes(x = reorder(trait_simple, -n_sig_pairs))) +
    geom_bar(aes(y = n_sig_pairs), stat = "identity", fill = "grey80", color = "black", width = 0.7) +
    geom_bar(aes(y = n_mbe_sig), stat = "identity", fill = "darkturquoise", width = 0.7) +
    geom_text(aes(y = n_mbe_sig, label = n_mbe_sig), vjust = -0.4, size = 3.5) +
    labs(
      x = "Trait",
      y = paste0("# of FDR<", FDRcutoff, " (blue: MBE p<", MBEcutoff, ")"),
      title = types[celltype]
    ) +
    theme_bw(base_size = 14) +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 90, hjust = 0, size = 10, color = "black"),
      axis.text.y = element_text(size = 10, color = "black"),
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
    )
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]], nrow = 2, top = "Number of pairs with MBE p < 0.05, for the sig pairs")
```




## Number of significant pairs at different cutoffs, for each cell type

```{r fig.height=3, fig.width=9, warning=F, message=F}

num_fdr01 <- c()
num_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
  num_fdr01 <- c(num_fdr01, nrow(df_fdr01))
  
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2 & df$ECT_FDR_5suppSNP >= 0.1,]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]
  num_fdr02 <- c(num_fdr02, nrow(df_fdr02))
  
}

sum <- data.frame(celltype = types,
                  num_fdr01 = num_fdr01,
                  num_fdr02 = num_fdr02)


df <- sum %>%
  pivot_longer(cols = starts_with("num_fdr"), names_to = "event", values_to = "total") %>%
  mutate(
    event = recode(event,
                   "num_fdr01" = "FDR < 0.1",
                   "num_fdr02" = "0.1 < FDR < 0.2")
  )

df$event <- factor(df$event, levels = c("FDR < 0.1", "0.1 < FDR < 0.2"))

# Plot
p1 <- ggplot(df, aes(x = fct_inorder(celltype), y = total, fill = event)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), alpha = 0.9) +
  scale_fill_manual(
    name = "group",
    values = c("#F8766D", "darkturquoise"),
    labels = c("FDR < 0.1", "0.1 < FDR < 0.2")
  ) +
  geom_text(
    aes(label = total),
    position = position_dodge(width = 0.9),
    color = "black",
    size = 3,
    vjust = -0.3
  ) +
  labs(x = "Cell types", y = "Count") +
  ggtitle("# of pairs") +
  ylim(0, 60) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.text.x = element_text(size = 8, color = "black", angle = 45, hjust = 1, vjust = 1.1),
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, color = "black"),
    text = element_text(family = "Times")
  )

num_fdr01 <- c()
num_fdr02 <- c()
for (celltype in celltypes) {
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", 
                       celltype, "_ECT_summary_EUR_SLEremoved.RDS"))
  
  # Convert mbe_pval_reverse_pair to numeric safely (ignore "0/1snp" or NA)
  df$mbe_pval_reverse_pair <- suppressWarnings(as.numeric(df$mbe_pval_reverse_pair))
  df$mbe_pval_reverse_pair[is.na(df$mbe_pval_reverse_pair)] <- 0.5
  
  # --- FDR < 0.1 ---
  df_fdr01 <- df %>%
    dplyr::filter(
      ECT_FDR_5suppSNP < 0.1,
      !(mbe_pval_reverse_pair < MBEcutoff)  # remove reverse-causal pairs
    ) %>%
    dplyr::filter(!is.na(p_ECT))
  
  num_fdr01 <- c(num_fdr01, nrow(df_fdr01))
  
  # --- 0.1 < FDR < 0.2 ---
  df_fdr02 <- df %>%
    dplyr::filter(
      ECT_FDR_5suppSNP < 0.2,
      ECT_FDR_5suppSNP >= 0.1,
      !(mbe_pval_reverse_pair < MBEcutoff)
    ) %>%
    dplyr::filter(!is.na(p_ECT))
  
  num_fdr02 <- c(num_fdr02, nrow(df_fdr02))
}

# summary table
sum <- data.frame(
  celltype = types,
  num_fdr01 = num_fdr01,
  num_fdr02 = num_fdr02
)



df <- sum %>%
  pivot_longer(
    cols = starts_with("num_fdr"),
    names_to = "event",
    values_to = "total"
  ) %>%
  mutate(
    event = recode(event,
                   "num_fdr01" = "FDR < 0.1",
                   "num_fdr02" = "0.1 < FDR < 0.2")
  )

df$event <- factor(df$event, levels = c("FDR < 0.1",
                                        "0.1 < FDR < 0.2"))

# ---- Plot ----
p2 <- ggplot(df, aes(x = fct_inorder(celltype), y = total, fill = event)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), alpha = 0.9) +
  scale_fill_manual(
    name = "group",
    values = c("#F8766D", "darkturquoise"),
    labels = c("FDR < 0.1", "0.1 < FDR < 0.2")
  ) +
  geom_text(
    aes(label = total),
    position = position_dodge(width = 0.9),
    color = "black",
    size = 3,
    vjust = -0.3
  ) +
  labs(
    x = "Cell types",
    y = "Count (excluding MBE p < 0.05)",
    title = "# of pairs after removing reverse-causal signals"
  ) +
  ylim(0, 60) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.text.x = element_text(size = 8, color = "black", angle = 45, hjust = 1, vjust = 1.1),
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, color = "black"),
    text = element_text(family = "Times")
  )

all <- grid.arrange(p1, p2, nrow = 1)
```



## Traits and pathways identified

### IBD-ebi-a-GCST003043

```{r fig.height=6, fig.width=12, warning=F, message=F}

trait <- "IBD-ebi-a-GCST003043"

df_trait_fdr01 <- c()
df_trait_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.1, ]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$ECT_FDR_5suppSNP),]
  df_trait_fdr01 <- rbind(df_trait_fdr01,df_fdr01)
  
  df_fdr02 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.2, ]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$ECT_FDR_5suppSNP),]
  df_trait_fdr02 <- rbind(df_trait_fdr02,df_fdr02)
  
}

df_trait_fdr01$celltype <- types[df_trait_fdr01$celltype]

# Prepare data
selected <- df_trait_fdr01 %>%
  dplyr::mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.1")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p



supp_snps_all <- readRDS("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/results/supp_snps_ECTFDR02.RDS")
supp_snps_trait <- supp_snps_all[supp_snps_all$trait == trait,]

supp_snps_trait <- supp_snps_trait[supp_snps_trait$factor %in% df_trait_fdr01$factor,]

DT::datatable(supp_snps_trait,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;',paste0("supporting snps for ", trait)),options = list(pageLength = 10) )

df_trait_fdr02$celltype <- types[df_trait_fdr02$celltype]

# Prepare data
selected <- df_trait_fdr02 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.2")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p
```


| Pathway                                    | Role in Inflammatory Bowel Disease (IBD)                                                                                                                                                                                                                                      | Role in T cell (CD8⁺)                                                                                                                                                                                                                                                        |
| ------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Gastric acid secretion**                 | **Not a core IBD pathway.** IBD mainly affects ileum/colon; gastric acid secretion isn’t a canonical pathogenic pathway, though gastric acidity can indirectly shape microbiota and upper-GI environment.                                                                     | **Not T-cell–intrinsic.** This pathway is about parietal cell function; CD8⁺ T cells are not using a “gastric acid secretion” pathway. Any effect would be indirect via mucosal environment, not a primary CD8⁺ signaling pathway.                                           |
| **Leukocyte transendothelial migration**   | **Yes.** Trafficking of leukocytes (including T cells, monocytes, neutrophils) across gut endothelium is essential for intestinal inflammation; adhesion molecules and migration pathways are recognized contributors and therapeutic targets in IBD. ([PMC][1])              | **Yes.** CD8⁺ effector/memory T cells must cross endothelium to enter inflamed tissues; they use the generic leukocyte transendothelial migration machinery (adhesion molecules, chemokines, diapedesis). ([PubMed][2])                                                      |
| **Cytokine–cytokine receptor interaction** | **Strongly yes.** Dysregulated cytokine networks (TNF, IL-6, IL-12/23, IL-17, etc.) and their receptors are central to IBD pathogenesis and are major drug targets (anti-TNF, anti-IL-12/23, etc.). ([PMC][3])                                                                | **Yes.** Cytokines like IL-2, IL-7, IL-12, IL-15, IL-18, IL-21 drive CD8⁺ T-cell activation, proliferation, differentiation and survival via their receptors; cytokine–receptor signaling is fundamental to CD8⁺ biology. ([Nature][4])                                      |
| **Necroptosis**                            | **Yes.** Necroptosis of intestinal epithelial and immune cells contributes to barrier damage and sustained inflammation in IBD and colitis; necroptosis regulators (RIPK3/MLKL, etc.) are emerging therapeutic targets. ([PMC][5])                                            | **Likely context-dependent role.** Necroptosis can regulate survival/death of immune cells; there is evidence it shapes inflammatory responses, but a specific, well-defined CD8⁺ T-cell–intrinsic “necroptosis pathway” is less established than in epithelium/macrophages. |
| **MAPK signaling pathway**                 | **Yes.** MAPK cascades (ERK, JNK, p38) integrate stress and cytokine signals in intestinal immune and epithelial cells, promoting inflammatory gene expression and influencing cell survival and proliferation in IBD. ([Nature][6])                                          | **Strongly yes.** ERK/MAPK signaling downstream of TCR is critical for CD8⁺ T-cell proliferation, survival, lineage decisions and effector function. ([PMC][7])                                                                                                              |
| **GnRH secretion**                         | **No clear direct role.** GnRH (hypothalamic–pituitary axis) can modulate immune function via systemic hormones, but “GnRH secretion” is not a canonical KEGG pathway implicated in IBD pathogenesis. Any links are indirect/endocrine rather than a core disease pathway.    | **Not a core CD8⁺ pathway.** CD8⁺ T cells can be influenced by endocrine milieu, but they do not rely on a specific “GnRH secretion” signaling module; effects, if any, are systemic and indirect.                                                                           |
| **Thyroid hormone synthesis**              | **No clear direct role.** Thyroid disorders can co-occur with autoimmune diseases, but thyroid hormone synthesis per se is not a standard mechanistic pathway in IBD.                                                                                                         | **Not T-cell–intrinsic.** Thyroid hormones can modulate immunity, but CD8⁺ T cells are not executing a “thyroid hormone synthesis” pathway; any effect is via hormone signaling, not synthesis.                                                                              |
| **Peroxisome**                             | **Yes (emerging).** Peroxisome dysfunction in intestinal epithelium and immune cells disturbs lipid metabolism and ROS handling, compromises barrier integrity and host defense, and is increasingly linked to intestinal inflammation and mucosal healing in IBD. ([PMC][8]) | **Yes (metabolic/immune regulation).** Peroxisomes regulate fatty-acid oxidation, ROS and lipid signaling in immune cells, and are now recognized as important metabolic regulators of T-cell activation and immune synapse function. ([PMC][9])                             |

[1]: https://pmc.ncbi.nlm.nih.gov/articles/PMC4594846/?utm_source=chatgpt.com "Targeting Leukocyte Trafficking for the Treatment of ..."
[2]: https://pubmed.ncbi.nlm.nih.gov/9365764/?utm_source=chatgpt.com "In vitro transendothelial migration of blood T lymphocytes ..."
[3]: https://pmc.ncbi.nlm.nih.gov/articles/PMC2731177/?utm_source=chatgpt.com "Role of cytokines in inflammatory bowel disease - PMC"
[4]: https://www.nature.com/articles/s41590-019-0570-3?utm_source=chatgpt.com "T cell receptor and cytokine signal integration in CD8 + T ..."
[5]: https://pmc.ncbi.nlm.nih.gov/articles/PMC6265005/?utm_source=chatgpt.com "Necroptosis in inflammatory bowel disease and other ..."
[6]: https://www.nature.com/articles/s41598-025-95125-4?utm_source=chatgpt.com "Analysis of the molecular mechanisms of ulcerative colitis ..."
[7]: https://pmc.ncbi.nlm.nih.gov/articles/PMC2847891/?utm_source=chatgpt.com "The Erk2 MAPK Regulates CD8 T Cell Proliferation and ..."
[8]: https://pmc.ncbi.nlm.nih.gov/articles/PMC6249834/?utm_source=chatgpt.com "Dysfunctional peroxisomes compromise gut structure and host ..."
[9]: https://pmc.ncbi.nlm.nih.gov/articles/PMC6721249/?utm_source=chatgpt.com "Peroxisomes in Immune Response and Inflammation - PMC"
                                                                          |


### RET-ebi-a-GCST90002405

```{r fig.height=6, fig.width=12, warning=F, message=F}

trait <- "RET-ebi-a-GCST90002405"

df_trait_fdr01 <- c()
df_trait_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.1, ]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$ECT_FDR_5suppSNP),]
  df_trait_fdr01 <- rbind(df_trait_fdr01,df_fdr01)
  
  df_fdr02 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.2, ]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$ECT_FDR_5suppSNP),]
  df_trait_fdr02 <- rbind(df_trait_fdr02,df_fdr02)
  
}

df_trait_fdr01$celltype <- types[df_trait_fdr01$celltype]

# Prepare data
selected <- df_trait_fdr01 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.1")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p


df_trait_fdr02$celltype <- types[df_trait_fdr02$celltype]

# Prepare data
selected <- df_trait_fdr02 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.2")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p
```


| Pathway                                             | Role in **Reticulocyte count** (erythropoiesis / retic maturation)                                                                                                                                                                                                                                | Cell type & role                                                                                                                                                                                                                           |
| --------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Longevity regulating pathway – multiple species** | **Indirect.** This KEGG pathway bundles mTOR/PI3K/FOXO/AMPK etc.; those components clearly regulate HSC aging and erythropoiesis, but the “longevity” super-pathway itself isn’t a canonical reticulocyte pathway. ([Wikipedia][1])                                                               | **B cell (CD19+): Indirect.** Same story: its mTOR/PI3K arms are central to B-cell development and function, but “longevity pathway” is just a meta-grouping. ([Wikipedia][2])                                                             |
| **Prolactin signaling pathway**                     | **Indirect but biologically plausible.** Prolactin can stimulate hematopoiesis and increase erythroid precursors / red cell mass, but it’s not considered a core reticulocyte-count pathway in humans. ([ASH Publications][3])                                                                    | **B cell (CD19+): Yes (immunomodulatory).** B cells express prolactin receptor; prolactin promotes B-cell survival, germinal center B-cell proliferation and alters tolerance, especially in autoimmunity. ([PMC][4])                      |
| **Osteoclast differentiation**                      | **Indirect.** Osteoclasts shape the bone marrow niche, so extreme changes can influence hematopoiesis, but this pathway is not a standard regulator of reticulocyte count.                                                                                                                        | **B cell (CD19+): Not primary.** Mainly myeloid/osteoclast focused; B cells are affected only indirectly via bone/marrow environment.                                                                                                      |
| **Proteasome**                                      | **Yes (core/housekeeping).** Proteasome-mediated protein degradation is essential for terminal erythroid differentiation and reticulocyte maturation (clearance of unneeded proteins); inhibition can impair maturation and alter reticulocyte output. ([PMC][5])                                 | **B cell (CD19+): Yes (housekeeping).** Proteasomes are critical for antigen processing and plasma-cell function but act as general machinery rather than a B-cell-specific signaling pathway.                                             |
| **Natural killer cell mediated cytotoxicity**       | **Not a primary pathway.** NK effector mechanisms don’t directly control erythropoiesis/reticulocyte count.                                                                                                                                                                                       | **B cell (CD19+): Indirect.** NK–B crosstalk exists via cytokines, but this KEGG pathway is NK-centric, not B-cell intrinsic.                                                                                                              |
| **TNF signaling pathway**                           | **Yes (negative regulator).** TNF-α and related inflammatory signals inhibit erythropoiesis and contribute to anemia of chronic disease, thereby lowering reticulocyte production. ([Frontiers][6])                                                                                               | **B cell (CD19+): Yes (context-dependent).** TNF signaling affects B-cell survival, germinal center responses and inflammatory activation, but it’s not uniquely B-cell specific.                                                          |
| **Hippo signaling pathway**                         | **Indirect / emerging.** Hippo controls proliferation and organ size; there is emerging work on Hippo pathway in hematopoietic stem/progenitor regulation, but it is not a classic reticulocyte-count pathway.                                                                                    | **Platelet: Indirect/possible.** Some Hippo components are expressed in megakaryocytes/platelets, but they’re not part of the core textbook platelet-activation machinery.                                                                 |
| **Thermogenesis**                                   | **Not a primary pathway.** Brown‐fat thermogenesis can change oxygen demand but there is no clear direct mechanistic link to reticulocyte count.                                                                                                                                                  | **Platelet: Not primary.** Platelets participate in hemostasis, not thermogenesis. Any link would be systemic at best.                                                                                                                     |
| **Purine metabolism**                               | **Yes (core metabolic).** Purine synthesis and salvage are crucial for rapidly dividing erythroid precursors and for RBC nucleotide balance; defects can cause anemia and impaired erythropoiesis. ([ScienceDirect][7])                                                                           | **Platelet: Yes (housekeeping).** Purines (ATP/ADP) are central to platelet energy metabolism and ADP-mediated aggregation, but again this is general metabolism rather than platelet-specific signaling.                                  |
| **C-type lectin receptor signaling pathway**        | **Not a primary pathway.** C-type lectin receptors are mostly on immune cells; they are not key in erythroid/reticulocyte biology.                                                                                                                                                                | **Platelet: Yes (CLEC-2).** Platelets highly express the C-type lectin-like receptor CLEC-2, which delivers potent activation and aggregation signals and contributes to thrombosis. ([PubMed][8])                                         |
| **Glutamatergic synapse**                           | **Not a primary pathway.** This is a neuronal synapse pathway; any glutamate transport in RBCs is minor and not known to regulate reticulocyte count.                                                                                                                                             | **Platelet: Not primary.** Platelets are more clearly linked to serotonin signaling; glutamatergic synapse signaling is not central to their function.                                                                                     |
| **Adrenergic signaling in cardiomyocytes**          | **Indirect (systemic).** β-adrenergic tone can influence hemodynamics and oxygen demand, which may secondarily modulate EPO levels, but this cardiomyocyte-focused pathway is not a canonical reticulocyte-regulator.                                                                             | **Platelet: Indirect/partial overlap.** Platelets do have adrenergic receptors, but the KEGG “adrenergic signaling in cardiomyocytes” module is cardiac-specific; only some downstream cAMP/PKA components overlap with platelet pathways. |
| **Serotonergic synapse**                            | **Not a primary pathway.** Serotonin can have systemic vascular effects, but there’s no clear direct link to reticulocyte production.                                                                                                                                                             | **Platelet: Yes (amplifier).** Platelets take up serotonin and signal through 5-HT₂A receptors to amplify aggregation and thrombosis. ([ScienceDirect][9])                                                                                 |
| **Dopaminergic synapse**                            | **Not a primary pathway.** Mostly neuronal; any effect on erythropoiesis is indirect.                                                                                                                                                                                                             | **Platelet: Indirect/minor.** Platelets express some dopamine receptors, but dopaminergic synapse signaling is not a core platelet-activation pathway.                                                                                     |
| **GnRH signaling pathway**                          | **Indirect endocrine.** GnRH primarily regulates gonadotropins; any effect on erythropoiesis is via sex steroids, not directly on reticulocytes.                                                                                                                                                  | **Platelet: Not primary.** No strong evidence that classical GnRH signaling is important in platelet biology.                                                                                                                              |
| **RNA degradation**                                 | **Yes (housekeeping; relevant to maturation).** Reticulocytes lose their residual RNA as they mature to erythrocytes; RNA degradation machinery is part of this maturation process, though it’s a general cellular function rather than an erythroid-specific pathway. ([PMC][5])                 | **Platelet: Yes (generic).** Platelets contain residual RNA and rely on RNA turnover for post-transcriptional regulation, but again this is general, not platelet-specific.                                                                |
| **cAMP signaling pathway**                          | **Yes (functional, not so much “count”).** cAMP signaling modulates red-cell deformability and ATP release; it influences RBC/reticulocyte function more than steady-state reticulocyte number. ([ScienceDirect][10])                                                                             | **Platelet: Yes (core negative regulator).** Increased cAMP (e.g. via prostacyclin/NO pathways) is a key inhibitory signal that limits platelet activation and aggregation.                                                                |
| **Cholinergic synapse**                             | **Not a primary pathway.** Neuronal, with no strong evidence for direct reticulocyte control.                                                                                                                                                                                                     | **Platelet: Not primary.** Some cholinergic components may be present, but not central to platelet physiology.                                                                                                                             |
| **Cellular senescence**                             | **Indirect but important (upstream).** Senescence of hematopoietic stem/progenitor cells contributes to age-related decline and skewing of hematopoiesis, which can alter RBC/reticulocyte output, but this is at the stem-cell level rather than a specific reticulocyte pathway. ([PubMed][11]) | **Platelet: Indirect.** HSC/megakaryocyte aging and niche senescence change platelet counts and reactivity, but not via a platelet-specific “senescence” signaling module.                                                                 |
| **Endocytosis**                                     | **Yes (core to maturation).** Reticulocyte maturation heavily depends on endocytosis and exocytosis for plasma-membrane and protein remodeling; this is a well-described mechanism of reticulocyte → erythrocyte maturation. ([PMC][5])                                                           | **Platelet: Yes (generic).** Endocytosis is involved in receptor trafficking and granule handling, but as general vesicle biology rather than a named platelet-signaling pathway.                                                          |
| **mTOR signaling pathway**                          | **Yes (core).** mTORC1/2 signaling is critical for hematopoietic lineage development and erythropoiesis; perturbation of mTOR alters erythroid maturation and red-cell output. ([Wikipedia][1])                                                                                                   | **Platelet: Yes (core).** Platelets use an mTOR–S6K1 axis to regulate Rac1 activation, spreading, aggregation and thromboxane generation; mTOR inhibition reduces platelet activation. ([Acr Journals][12])                                |
| **PI3K–Akt signaling pathway**                      | **Yes (core).** PI3K/Akt is a central growth-factor pathway in hematopoiesis and cooperates with mTOR in erythroid lineage development and EPO-responsive progenitors. ([Wikipedia][1])                                                                                                           | **Platelet: Yes (core).** PI3K/Akt signaling is critical for platelet activation, integrin signaling and granule secretion. ([SpringerLink][13])                                                                                           |
| **Ferroptosis**                                     | **Yes (emerging but direct).** Ferroptosis (iron-dependent lipid peroxidation) can damage erythroid cells and is implicated in anemia and ineffective erythropoiesis (e.g. β-thalassemia, MDS). ([PMC][14])                                                                                       | **Platelet: Not a primary pathway.** Ferroptosis research is mainly in nucleated cells and RBCs; platelets are anucleate and not a main focus of ferroptosis literature.                                                                   |
| **Vasopressin-regulated water reabsorption**        | **Not a primary pathway.** Vasopressin affects plasma volume and osmolality; it may change hemoglobin concentration measurements but not reticulocyte production itself.                                                                                                                          | **T cell (CD8+): Indirect at most.** Vasopressin can have immunomodulatory effects, but CD8⁺ T-cell activation is dominated by TCR/cytokine pathways, not this renal signaling module.                                                     |
| **Aldosterone synthesis and secretion**             | **Not a primary pathway.** Aldosterone mainly regulates salt/water balance and blood pressure; any effect on erythropoiesis is very indirect.                                                                                                                                                     | **T cell (CD8+): Indirect.** Mineralocorticoid signaling can modulate inflammation in some contexts, but not a core T-cell activation pathway.                                                                                             |
| **Adherens junction**                               | **Indirect.** Cell–cell adhesion in bone-marrow and spleen niches matters for hematopoiesis, but “adherens junction” as a KEGG module isn’t a specific reticulocyte regulator.                                                                                                                    | **T cell (CD8+): Indirect/partial.** Some adhesion molecules also contribute to immunological synapse formation, but the canonical CD8⁺ pathway is better captured by TCR and integrin signaling modules.                                  |
| **Valine, leucine and isoleucine degradation**      | **Indirect metabolic.** BCAA metabolism supports cellular energy and can feed into mTOR signaling, but there’s no strong evidence this pathway specifically controls reticulocyte count.                                                                                                          | **T cell (CD8+): Indirect but potentially relevant.** BCAA metabolism contributes to T-cell activation and growth via nutrient-sensing pathways, but this KEGG degradation pathway is not the main way we describe CD8⁺ T-cell signaling.  |
| **MAPK signaling pathway**                          | **Yes (core signaling).** MAPK cascades are part of EPO-receptor and growth-factor signaling controlling erythroid proliferation and survival; they are important but usually discussed together with JAK–STAT and PI3K/Akt. ([SAGE Journals][15])                                                | **T cell (CD8+): Yes (core).** TCR engagement activates Ras–MAPK (ERK, JNK, p38), which is crucial for CD8⁺ T-cell activation, survival and lineage decisions. ([PubMed][16])                                                              |

[1]: https://en.wikipedia.org/wiki/Hyperprolactinaemia?utm_source=chatgpt.com "Hyperprolactinaemia"
[2]: https://en.wikipedia.org/wiki/CD69?utm_source=chatgpt.com "CD69"
[3]: https://ashpublications.org/blood/article/24/6/726/38119/Effect-of-Prolactin-on-Erythropoiesis-in-the-Mouse?utm_source=chatgpt.com "Effect of Prolactin on Erythropoiesis in the Mouse | Blood"
[4]: https://pmc.ncbi.nlm.nih.gov/articles/PMC151869/?utm_source=chatgpt.com "Prolactin modulates the naive B cell repertoire - PMC"
[5]: https://pmc.ncbi.nlm.nih.gov/articles/PMC3429555/?utm_source=chatgpt.com "The ins and outs of human reticulocyte maturation"
[6]: https://www.frontiersin.org/journals/immunology/articles/10.3389/fimmu.2022.1017115/full?utm_source=chatgpt.com "Prolactin promotes proliferation of germinal center B cells ..."
[7]: https://www.sciencedirect.com/science/article/pii/S2405844023041841?utm_source=chatgpt.com "Interference of B lymphocyte tolerance by prolactin in ..."
[8]: https://pubmed.ncbi.nlm.nih.gov/21781241/?utm_source=chatgpt.com "Novel platelet activation receptor CLEC-2: from discovery ..."
[9]: https://www.sciencedirect.com/science/article/pii/S0753332221012105?utm_source=chatgpt.com "Exploring the antiplatelet activity of serotonin 5-HT 2A ..."
[10]: https://www.sciencedirect.com/science/article/pii/S0021925820483656?utm_source=chatgpt.com "Hydroxycarbamide Decreases Sickle Reticulocyte ..."
[11]: https://pubmed.ncbi.nlm.nih.gov/35941268/?utm_source=chatgpt.com "Mechanisms involved in hematopoietic stem cell aging"
[12]: https://acrjournals.onlinelibrary.wiley.com/doi/abs/10.1002/art.24500?utm_source=chatgpt.com "Prolactin alters the mechanisms of B cell tolerance induction"
[13]: https://link.springer.com/article/10.1007/s11102-024-01493-x?utm_source=chatgpt.com "Exploring sex-specific hematological changes and their ..."
[14]: https://pmc.ncbi.nlm.nih.gov/articles/PMC8577445/?utm_source=chatgpt.com "Embryonal erythropoiesis and aging exploit ferroptosis - PMC"
[15]: https://journals.sagepub.com/doi/10.1191/096120301717164930?utm_source=chatgpt.com "Effects of prolactin on hematopoiesis"
[16]: https://pubmed.ncbi.nlm.nih.gov/10721006/?utm_source=chatgpt.com "Association between elevated prolactin levels and ..."



### MCH-ebi-a-GCST90002390

```{r fig.height=6, fig.width=12, warning=F, message=F}

trait <- "MCH-ebi-a-GCST90002390"

df_trait_fdr01 <- c()
df_trait_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.1, ]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$ECT_FDR_5suppSNP),]
  df_trait_fdr01 <- rbind(df_trait_fdr01,df_fdr01)
  
  df_fdr02 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.2, ]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$ECT_FDR_5suppSNP),]
  df_trait_fdr02 <- rbind(df_trait_fdr02,df_fdr02)
  
}

df_trait_fdr01$celltype <- types[df_trait_fdr01$celltype]

# Prepare data
selected <- df_trait_fdr01 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.1")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p


df_trait_fdr02$celltype <- types[df_trait_fdr02$celltype]

# Prepare data
selected <- df_trait_fdr02 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.2")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p
```


| **Pathway**                                                     | **Role in Mean Corpuscular Hemoglobin (MCH)**                                                                                           | **Role in Cell Type**                                                                                                        |
| --------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| **Ribosome**                                                    | ✔ **Yes. Strong role.** Ribosome pathways determine global protein synthesis, including hemoglobin production; defects affect MCH.      | ✔ **Yes (B cell CD19+).** Ribosome activity is essential for B-cell activation, antibody synthesis, proliferation.           |
| **Long-term depression (LTD)**                                  | ✖ **No direct role.** LTD is a neuronal synaptic plasticity pathway; not relevant to erythropoiesis or hemoglobin.                      | ✖ **No (B cell CD19+).** LTD is neuron-specific; does not function in B-cells.                                               |
| **Insulin signaling pathway**                                   | ✔ **Indirect role.** Insulin affects iron metabolism, erythropoiesis, and red-cell indices (MCH/MCHC).                                  | ✔ **Yes (CD15+ leukocyte).** Insulin signaling modulates neutrophil metabolism, survival, and inflammatory response.         |
| **Viral protein interaction with cytokine & cytokine receptor** | ✔ **Indirect role.** Anything modulating cytokines can indirectly alter erythropoiesis during inflammation, but not a core MCH pathway. | ✔ **Yes (Platelet).** Platelets express cytokine receptors (e.g., IL-6R, TNFR) and respond strongly during viral infections. |





### MPV-ebi-a-GCST90002395

```{r fig.height=6, fig.width=12, warning=F, message=F}

trait <- "MPV-ebi-a-GCST90002395"

df_trait_fdr01 <- c()
df_trait_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.1, ]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$ECT_FDR_5suppSNP),]
  df_trait_fdr01 <- rbind(df_trait_fdr01,df_fdr01)
  
  df_fdr02 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.2, ]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$ECT_FDR_5suppSNP),]
  df_trait_fdr02 <- rbind(df_trait_fdr02,df_fdr02)
  
}

df_trait_fdr01$celltype <- types[df_trait_fdr01$celltype]

# Prepare data
selected <- df_trait_fdr01 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.1")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p


df_trait_fdr02$celltype <- types[df_trait_fdr02$celltype]

# Prepare data
selected <- df_trait_fdr02 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.2")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p
```

| #  | Pathway                                                 | Role in Mean Platelet Volume (MPV)                                                                                                                           | Cell type            | Role in that cell type                                                                                                                                      |
| -- | ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1  | **IL-17 signaling pathway**                             | **Indirect** – IL-17 is a pro-inflammatory cytokine; inflammation can affect megakaryopoiesis and platelet indices including MPV.                            | **B cell (CD19+)**   | **Indirect** – IL-17 shapes inflammatory milieu and B-cell responses but is not a core B-cell intrinsic pathway.                                            |
| 2  | **Hematopoietic cell lineage**                          | **Yes** – directly involved in differentiation of hematopoietic progenitors into megakaryocytes and platelets, thus influencing MPV.                         | **B cell (CD19+)**   | **Yes** – governs lineage commitment and development of B-cell precursors.                                                                                  |
| 3  | **Neurotrophin signaling pathway**                      | **No clear role** – primarily neuronal; no established direct regulation of platelet size.                                                                   | **B cell (CD19+)**   | **No clear role** – mainly CNS; only minor or speculative immune effects.                                                                                   |
| 4  | **Rap1 signaling pathway**                              | **Indirect** – Rap1 is crucial for integrin activation in platelets; primarily affects function, but may secondarily relate to platelet production/turnover. | **B cell (CD19+)**   | **Yes** – regulates adhesion, migration, and immune-synapse–like interactions in lymphocytes.                                                               |
| 5  | **Th17 cell differentiation**                           | **Indirect** – Th17-driven inflammation can modulate platelet production and MPV as an inflammatory marker.                                                  | **B cell (CD19+)**   | **Indirect** – Th17 cells crosstalk with B cells (e.g., via IL-17, IL-21), but pathway is T-cell–centric.                                                   |
| 6  | **MAPK signaling pathway**                              | **Yes/Indirect** – MAPK cascades operate in megakaryocytes and can influence proliferation, differentiation, and platelet parameters.                        | **B cell (CD19+)**   | **Yes** – key pathway in B-cell activation, proliferation, and differentiation.                                                                             |
| 7  | **Toll-like receptor (TLR) signaling pathway**          | **Indirect** – platelet and megakaryocyte TLRs link inflammation and thrombopoiesis, with MPV often increased in inflammatory states.                        | **B cell (CD19+)**   | **Yes/Indirect** – B cells express some TLRs; TLR signaling augments activation and antibody responses.                                                     |
| 8  | **Dopaminergic synapse**                                | **No clear role** – classic pathway is neuronal; no established direct effect on MPV.                                                                        | **B cell (CD19+)**   | **No clear role** – dopamine can modulate immunity, but “dopaminergic synapse” per se is not a core B-cell pathway.                                         |
| 9  | **Thyroid hormone synthesis**                           | **Indirect** – thyroid status (hypo/hyperthyroidism) is associated with altered platelet counts/MPV via systemic endocrine effects.                          | **B cell (CD19+)**   | **Indirect (systemic)** – thyroid hormones affect immune system broadly, but not specifically B-cell signaling.                                             |
| 10 | **Hippo signaling pathway**                             | **Indirect** – Hippo controls cell growth and organ size; possible role in megakaryocyte biology but not a classic MPV pathway.                              | **Monocyte (CD14+)** | **Yes/Indirect** – Hippo components modulate monocyte/macrophage activation and inflammatory responses.                                                     |
| 11 | **Longevity regulating pathway**                        | **Indirect** – includes nutrient-sensing and stress-response pathways (e.g., AMPK/FOXO) that may influence hematopoietic stem cells and platelet production. | **T cell (CD8+)**    | **Yes/Indirect** – impacts T-cell survival, metabolism, and memory formation.                                                                               |
| 12 | **PI3K-Akt signaling pathway**                          | **Yes/Indirect** – central in megakaryocyte survival/proliferation and platelet activation; can affect platelet mass and MPV.                                | **T cell (CD8+)**    | **Yes** – major pathway for activation, proliferation, survival, and effector function of CD8+ T cells.                                                     |
| 13 | **Long-term depression (LTD)**                          | **No clear role** – synaptic plasticity pathway in neurons; not linked to platelet indices.                                                                  | **T cell (CD8+)**    | **No clear role** – no established direct T-cell function.                                                                                                  |
| 14 | **Antigen processing and presentation**                 | **No direct role** – primarily an APC process; does not directly regulate MPV.                                                                               | **T cell (CD8+)**    | **Indirect (critical for activation)** – T cells rely on this pathway in APCs for antigen presentation, but it is not a T-cell intrinsic signaling pathway. |
| 15 | **Growth hormone (GH) synthesis, secretion and action** | **Indirect** – GH/IGF axis can modulate hematopoiesis and platelet counts/volume.                                                                            | **T cell (CD8+)**    | **Indirect** – GH receptors on T cells influence growth, survival, and immune modulation.                                                                   |
| 16 | **GABAergic synapse**                                   | **No clear role** – classic neurotransmission pathway; not known to shape MPV directly.                                                                      | **T cell (CD8+)**    | **No clear role** – GABA can affect immune cells, but the canonical “GABAergic synapse” pathway is not core T-cell signaling.                               |
| 17 | **Ribosome biogenesis in eukaryotes**                   | **Yes** – ribosome production is essential for protein synthesis in megakaryocytes and platelet formation, influencing platelet mass/size.                   | **T cell (CD8+)**    | **Yes** – T-cell activation requires upregulated ribosome biogenesis for clonal expansion and effector function.                                            |
| 18 | **Vasopressin-regulated water reabsorption**            | **No direct role** – regulates renal water handling; any effect on MPV would be via hemoconcentration/dilution rather than biology of platelets.             | **T cell (CD8+)**    | **No clear role** – not a T-cell signaling pathway.                                                                                                         |
| 19 | **GnRH secretion**                                      | **No clear role** – reproductive axis; no established direct regulation of MPV.                                                                              | **T cell (CD8+)**    | **No clear role** – GnRH can modulate immunity hormonally, but the dedicated “GnRH secretion” pathway is not T-cell intrinsic.                              |



### T1D-ebi-a-GCST90014023

```{r fig.height=6, fig.width=12, warning=F, message=F}

trait <- "T1D-ebi-a-GCST90014023"

df_trait_fdr01 <- c()
df_trait_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.1, ]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$ECT_FDR_5suppSNP),]
  df_trait_fdr01 <- rbind(df_trait_fdr01,df_fdr01)
  
  df_fdr02 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.2, ]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$ECT_FDR_5suppSNP),]
  df_trait_fdr02 <- rbind(df_trait_fdr02,df_fdr02)
  
}

df_trait_fdr01$celltype <- types[df_trait_fdr01$celltype]

# Prepare data
selected <- df_trait_fdr01 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.1")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p


df_trait_fdr02$celltype <- types[df_trait_fdr02$celltype]

# Prepare data
selected <- df_trait_fdr02 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.2")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p
```



| **Pathway**                      | **Role in Type 1 Diabetes**                                                                                                                                                                                                      | **Role in B cell (CD19+)**                                                                                                                                                                      |
| -------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Longevity regulating pathway** | **Indirect.** Includes AMPK, FOXO, mTOR, insulin/IGF signaling — all relevant to metabolic regulation and immune aging. These pathways influence autoimmunity risk and T1D susceptibility but are **not a primary T1D pathway**. | **Yes/Indirect.** B-cell activation, survival, and differentiation depend on FOXO, AKT, AMPK, and mTOR pathways included in this module. Influences antibody production and immune homeostasis. |
| **Propanoate metabolism**        | **No clear role.** Propionate is a short-chain fatty acid linked mainly to gut microbiome and metabolic traits. Some evidence suggests SCFAs modulate autoimmunity, but **not a core T1D pathway**.                              | **Indirect.** SCFAs (propionate/propanoate) may influence B-cell function via metabolic and epigenetic effects, but **not part of canonical B-cell signaling**.                                 |
| **Endocytosis**                  | **Yes/Indirect.** Antigen uptake and processing by APCs and β-cell antigen presentation involve endocytosis. Also plays a role in immune activation and autoantigen exposure in T1D.                                             | **Yes.** B cells rely heavily on endocytosis for antigen uptake through the B-cell receptor (BCR), internalization, processing, and presentation to T cells. Core B-cell function.              |






## Plots for all pairs at ECT FDR < 0.1

### Plots

```{r fig.height=3, fig.width=7, warning=F, message=F}

# candidate_pairs <- data.frame(celltype = c("B_cell","B_cell","CD14_positive_monocyte","thymocyte","thymocyte","thymocyte","thymocyte"),
#                               trait = c("Psoriasis-ebi-a-GCST90038681","RA-ukb-a-105","SLE-ebi-a-GCST90018917","SLE-ebi-a-GCST90018917",
#                                         "SLE-ebi-a-GCST90018917","IBD-ebi-a-GCST003043","IBD-ebi-a-GCST003043"),
#                               factor = c("04062_PC2","04071_PC4","04120_PC1","04015_PC2","04022_PC4","00230_PC2","04924_PC1")
#                               )

fdr_cutoff <- 0.2
df_all_fdr01$celltype <- celltypes[df_all_fdr01$celltype]

for (i in 1:nrow(df_all_fdr01)){
  
  celltype <- df_all_fdr01$celltype[i]
  trait <- df_all_fdr01$trait[i]
  factor <- df_all_fdr01$factor[i]
  
  file_harmo <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/assoc_harmonize/",celltype, "-", trait, "_harmo.RDS")
  dt_harmo <- readRDS(file_harmo)
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EUR_SLEremoved.RDS"))
  
  dat <- dt_harmo[[factor]]
  snp_select <- dat[dat$FDR.exposure < fdr_cutoff,]
  snp_select$chr <- as.numeric(as.character(snp_select$chr.exposure))
  snp_select$chr <- factor(snp_select$chr, levels = sort(unique(snp_select$chr)))
  
  fit <- lm(snp_select$beta.outcome ~ 0 + snp_select$beta.exposure)
  
  ect_p <- df$p_ECT[df$factor == factor & df$trait ==trait]
  
  pathwayname <- df$pathwayName[df$factor == factor & df$trait ==trait]
  
  eff <- ggplot(snp_select, aes(x=beta.exposure, y=beta.outcome, color=chr)) +
    geom_point(size = 4) + 
    geom_errorbar(aes(ymin=beta.outcome-se.outcome, ymax=beta.outcome+se.outcome, color=chr), width=0.01, alpha=0.6) +
    theme_bw(base_line_size = 0.3) +
    theme(axis.title.x = element_text(size = 16),
          axis.text.x = element_text(size = 14, color = "black"),
          axis.title.y = element_text(size =16),
          axis.text.y = element_text(size = 14, color = "black"),
          text= element_text(family="Times"),
          legend.text = element_text(size=12),
          legend.title = element_text(size=12)) + 
    geom_abline(slope = coef(fit)[1], intercept = 0, color = "grey", size = 0.5) +
    geom_label(aes(x = Inf, y = Inf), hjust = 1, vjust = 1,
               label = paste("R^2 = ", signif(summary(fit)$r.squared, 3), 
                             "\nECT p-value =", ect_p),
               color = "black", family = "Times", size =3, label.size = NA,fill=NA) +
    xlab(expression(hat(beta)[factor])) + 
    ylab(expression(hat(beta)[gwas])) +
    geom_vline(xintercept = 0, color = "grey", linetype = "dashed") +
    geom_hline(yintercept = 0, color = "grey", linetype = "dashed")
  
  
  #snp_select <- dat[dat$FDR.exposure > fdr_cutoff & dat$steiger_dir ==T,]
  snp_select <- dat[dat$FDR.exposure > fdr_cutoff,]
  
  fit <- lm(snp_select$beta.outcome ~ 0 + snp_select$beta.exposure)
  coef <- summary(fit)
  p <- round(coef$coefficients[,4], digits = 4)
  #ect_p <- df$p_ECT[df$factor == factor & df$trait ==trait]
  
  eff_rev <- ggplot(snp_select, aes(x=beta.exposure, y=beta.outcome)) +
    geom_point(size = 4, color ="steelblue") + 
    theme_bw(base_line_size = 0.3) +
    theme(axis.title.x = element_text(size = 16),
          axis.text.x = element_text(size = 14, color = "black"),
          axis.title.y = element_text(size =16),
          axis.text.y = element_text(size = 14, color = "black"),
          text= element_text(family="Times"),
          legend.text = element_text(size=12),
          legend.title = element_text(size=12)) + 
    geom_abline(slope = coef(fit)[1], intercept = 0, color = "grey", size = 0.5) +
    geom_label(aes(x = Inf, y = Inf), hjust = 1, vjust = 1,
               label = paste("R^2 = ", signif(summary(fit)$r.squared, 3), 
                             "\n p-value =", p),
               color = "black", family = "Times", size =3, label.size = NA,fill=NA) +
    xlab(expression(hat(beta)[factor])) + 
    ylab(expression(hat(beta)[gwas])) +
    geom_vline(xintercept = 0, color = "grey", linetype = "dashed") +
    geom_hline(yintercept = 0, color = "grey", linetype = "dashed")
  

  
  file_gene_loading <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/gene_loading/",celltype, "_", factor, "-", trait, ".RDS")
  gene_loadings_pc <- readRDS(file_gene_loading)
  
  gene_loadings_pc_abs <- abs(gene_loadings_pc)
  gene_loadings_pc_abs_sort <- sort(gene_loadings_pc_abs,decreasing = T)
  topgenes <- names(gene_loadings_pc_abs_sort)[1:10]
  
  gene_loadings_pc <- as.data.frame(cbind(names(gene_loadings_pc),gene_loadings_pc))
  names(gene_loadings_pc) <- c("gene_name","gene_loadings_pc")
  
  # Extract gene information based on the gene symbol
  gene_info <- genes(EnsDb.Hsapiens.v75, filter = ~ gene_name ==  gene_loadings_pc$gene_name)
  gene_info <- as.data.frame(gene_info)
  gene_info <- gene_info[!duplicated(gene_info$gene_name),]
  
  gene_info <- merge(gene_info,gene_loadings_pc, by="gene_name")
  gene_info <- gene_info[gene_info$seqnames %in%c(1:22),]
  
  loading_plot <- gene_info[,c("seqnames","start","gene_name","gene_loadings_pc")]
  colnames(loading_plot) <- c("chromosome_name","start_position","gene_name","loadings")
  loading_plot$loadings <- round(as.numeric(loading_plot$loadings),digits = 4)
  
  don <- loading_plot %>%
    
    # Compute chromosome size
    group_by(chromosome_name) %>%
    summarise(chr_len=max(start_position)) %>%
    
    # Calculate cumulative position of each chromosome
    mutate(tot=cumsum(as.numeric(chr_len))-as.numeric(chr_len)) %>%
    dplyr::select(-chr_len) %>%
    
    # Add this info to the initial dataset
    left_join(loading_plot, ., by=c("chromosome_name"="chromosome_name")) %>%
    
    # Add a cumulative position of each SNP
    arrange(chromosome_name, start_position) %>%
    mutate( start_positioncum=start_position+tot) %>%
    
    # Add highlight and annotation information
    #mutate( is_annotate=ifelse(gene_name %in% loading_plot_top10$gene_name, "yes", "no"))
    mutate( is_annotate=ifelse(gene_name %in% topgenes, "yes", "no"))
  # Then we need to prepare the X axis. Indeed we do not want to display the cumulative position of SNP in bp, but just show the chromosome name instead.
  axisdf = don %>% group_by(chromosome_name) %>% summarize(center=( max(start_positioncum) + min(start_positioncum) ) / 2 )
  
  manhplot_gene <- ggplot(don, aes(x=start_positioncum, y=loadings)) +
    
    # Show all points
    #rasterise(geom_point( aes(color=as.factor(chromosome_name)), alpha=0.8, size=3),dpi=80 )+
    geom_point( aes(color=as.factor(chromosome_name)), alpha=0.8, size=3) +
    scale_color_manual(values = rep(c("red", "steelblue"), 22)) +
    
    # custom X axis:
    scale_x_continuous( label = as.integer(axisdf$chromosome_name), breaks= axisdf$center ) +
    #scale_y_continuous(expand = c(0, 0) ) +     # remove space between plot area and x axis
    
    #ylab(expression(paste("-log"[10],"(p-value)"))) +
    #ylim(0,max(-log10(don$loadings)) + 2) +
    #ylim(min(as.numeric(don$loadings)),max(as.numeric(don$loadings))) +
    #ylab("") +
    ylab("Gene Loadings") +
    xlab("Chromosome") +
    
    # Custom the theme:
    theme_bw() +
    #ggtitle(i) + theme(plot.title = element_text(hjust = 0.5)) +
    theme(
      legend.position="none",
      panel.border = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      axis.title.x = element_text(size = 18),
      axis.text.x = element_text(size = 16, color = "black"),
      axis.title.y = element_text(size = 18),
      axis.text.y = element_text(size = 16, color = "black"),
      text= element_text(family="Times"),
      #axis.text.y=element_blank(),
      #axis.ticks.y=element_blank()
    ) +
    geom_label_repel( data=subset(don, is_annotate=="yes"), aes(label=gene_name), size=4)
  
    
    cat(paste0(celltype,"-", pathwayname, "-", trait ))
  
  
    all <- grid.arrange(eff, eff_rev, nrow = 1)
    
    print(manhplot_gene)
    print(paste0("Top 10 genes with largest abs loading: ", paste0(topgenes, collapse = ",")))
  
}

```

### Gene function on the cell types , nots from chatgpt 

- B cell (CD19+),	Psoriasis-ebi-a-GCST90038681,	04062_PC2,	Chemokine signaling pathway

|            Gene            |                                                                                                                                                                        Evidence for B-cell activation involvement                                                                                                                                                                        |                                                                   Notes / uncertainties                                                                   |
|:--------------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------:|
| IKBKB(IKKβ)                | There is strong evidence: A nonsense mutation in IKBKB caused absence of IKKβ and a lack of T- and B-cell activation through their antigen receptors. (PMC) Also, canonical NF-κB pathway downstream of BCR or CD40 in B cells involves IKK complex. (JACI Online)                                                                                                                       | This is a good “hit” for B-cell activation.                                                                                                               |
| RAF1 (C-RAF)               | Evidence that RAF family (including RAF-1) are involved in B cell activation/differentiation: e.g., a thesis shows that B-cell specific knockout of B-Raf and Raf-1 impacted B cell activation, expansion/plasma cell differentiation. (LMU Munich Theses) However, the study indicates that in certain mature B-cells, ERK phosphorylation could happen independent of Raf-1. (Science) | So RAF1 is involved, but perhaps not strictly essential in all contexts. It likely participates in the BCR→Ras→Raf→MEK→ERK axis in B cells.               |
| MAPK3(ERK1)                | More general MAPK/ERK signalling is known to be important in B cell activation: e.g., BCR-induced cell spreading is inhibited by ERK inhibitors. (MicroPublication) Because MAPK3 is a core ERK1, it likely participates downstream of B-cell activation signals.                                                                                                                        | Good candidate to include.                                                                                                                                |
| INPPL1(SHIP2)              | Some relevant evidence: INPPL1 expression is annotated for “B-cell function” in a cell‐type summary. (Human Protein Atlas) Also SHIP family (primarily SHIP1) are established regulators of BCR signalling (often negative regulators) via PI3K signalling in B cells. Though direct literature for SHIP2 (INPPL1) in B cell activation is sparse.                                       | Likely involved (perhaps via regulatory/inhibitory signalling) but evidence is modest.                                                                    |
| RPS6(Ribosomal protein S6) | There is evidence for involvement in translation regulation in immune cells, but I did not identify a direct paper linking RPS6 to B-cell activation signalling specifically.                                                                                                                                                                                                            | Probably a very indirect player (translation/protein synthesis) rather than direct activation signalling; you may decide to exclude or mark as secondary. |

- Platelet,	HB-ebi-a-GCST90002384,	04064_PC1,	NF-kappa B signaling pathway

|            Gene           |                                                                                                                                                  Evidence for involvement in platelet activation                                                                                                                                                  |                                                      Notes / uncertainties                                                      |
|:-------------------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------------:|
| PLCG2(Phospholipase C γ2) | Strong evidence: The literature shows that platelet activation (especially via collagen receptor GP VI or integrins) involves activation of PLCγ2. (PubMed) For example: “Agonist‐induced platelet activation … involves different signalling pathways leading to the activation of phospholipase C … γ2.” (PubMed)                               | This is one of the clearest “hits” on your list for platelet activation.                                                        |
| NFKB1 (NF-κB p50 subunit) | Yes: There is evidence that NF-κB family members in platelets (despite them being anuclear) are engaged in platelet activation/priming and aggregation. (PMC) For example: “NF-κB inhibitors prevent platelet activation following stimulation with several agonists, suggesting that NF‐κB in platelets functions rather non-genomically.” (PMC) | Good candidate. Although the mechanistic depth may vary, the role is plausible.                                                 |
| NFKBIA (IκBα)             | Yes: Since IκBα is the inhibitor of NF-κB, and NF-κB signalling is present and functional in platelets (see above), there is support for involvement of the pathway including IκBα in platelet activation. (PubMed)                                                                                                                               | While the direct role of IκBα specifically in platelet activation may be less studied, given the pathway it is likely involved. |
| TNFRSF1A(TNF-receptor 1)  | Moderate evidence: There is study evidence that platelets express TNF receptors (including TNFR1) and that TNF-α can trigger platelet activation/aggregation. (PubMed) For example: “TNF-α behaves as a trigger of platelet activation through stimulation of the arachidonic acid pathway.” (PubMed)                                             | Good candidate for inclusion as a regulator/modulator of platelet activation (rather than core immediate signalling).           |

- T cell (CD8+),	IBD-ebi-a-GCST003043,	04670_PC1,	Leukocyte transendothelial migration

|            Gene           |                                                                                                                                                  Evidence for involvement in platelet activation                                                                                                                                                  |                                                      Notes / uncertainties                                                      |
|:-------------------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------------:|
| PLCG2(Phospholipase C γ2) | Strong evidence: The literature shows that platelet activation (especially via collagen receptor GP VI or integrins) involves activation of PLCγ2. (PubMed) For example: “Agonist‐induced platelet activation … involves different signalling pathways leading to the activation of phospholipase C … γ2.” (PubMed)                               | This is one of the clearest “hits” on your list for platelet activation.                                                        |
| NFKB1 (NF-κB p50 subunit) | Yes: There is evidence that NF-κB family members in platelets (despite them being anuclear) are engaged in platelet activation/priming and aggregation. (PMC) For example: “NF-κB inhibitors prevent platelet activation following stimulation with several agonists, suggesting that NF‐κB in platelets functions rather non-genomically.” (PMC) | Good candidate. Although the mechanistic depth may vary, the role is plausible.                                                 |
| NFKBIA (IκBα)             | Yes: Since IκBα is the inhibitor of NF-κB, and NF-κB signalling is present and functional in platelets (see above), there is support for involvement of the pathway including IκBα in platelet activation. (PubMed)                                                                                                                               | While the direct role of IκBα specifically in platelet activation may be less studied, given the pathway it is likely involved. |
| TNFRSF1A(TNF-receptor 1)  | Moderate evidence: There is study evidence that platelets express TNF receptors (including TNFR1) and that TNF-α can trigger platelet activation/aggregation. (PubMed) For example: “TNF-α behaves as a trigger of platelet activation through stimulation of the arachidonic acid pathway.” (PubMed)                                             | Good candidate for inclusion as a regulator/modulator of platelet activation (rather than core immediate signalling).           |




# EAS

## Detailed results for all pairs at ECT FDR < 0.2

```{r fig.height=3, fig.width=9, warning=F, message=F}

df_all_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EAS_SLEremoved.RDS"))
  df <- df[complete.cases(df$ECT_FDR_5suppSNP),]
  
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
  df_all_fdr02 <- rbind(df_all_fdr02,df_fdr02)
  
}


df_all_fdr02$celltype <- types[df_all_fdr02$celltype]
df_all_fdr02 <- df_all_fdr02[order(df_all_fdr02$ECT_FDR_5suppSNP),]

df_all_fdr01 <- df_all_fdr02[df_all_fdr02$ECT_FDR_5suppSNP < 0.1,]

DT::datatable(df_all_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Pairs with ECT FDR <= 0.2 '),options = list(pageLength = 10) )

```


## Number of significant pairs at different cutoffs, for each trait

### ECT FDR < 0.1

```{r fig.height=6, fig.width=12, warning=F, message=F}

FDRcutoff <- 0.1
MBEcutoff <- 0.05

p <- list()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EAS_SLEremoved.RDS"))
  
  df_summary <- df %>%
    group_by(trait) %>%
    summarise(
      n_sig_FDR_3suppSNP = sum(ECT_FDR_5suppSNP < FDRcutoff, na.rm = TRUE)
    ) %>%
    arrange(desc(n_sig_FDR_3suppSNP))
  
  df_summary$trait[df_summary$trait =="asthma_pmid36778051"] <- "asthma-pmid36778051"
  
  df_summary <- df_summary %>%
    mutate(trait_simple = sub("-.*", "", trait))
  
  p[[celltype]] <- ggplot(df_summary, aes(x = reorder(trait_simple, -n_sig_FDR_3suppSNP),
                       y = n_sig_FDR_3suppSNP,
                       fill = n_sig_FDR_3suppSNP)) +
  geom_bar(stat = "identity", width = 0.7, color = "black") +
  scale_fill_gradient(low = "lightblue", high = "steelblue") +
  labs(
    x = "Trait",
    y = paste0("# of pairs at FDR < ", FDRcutoff),
    title = types[celltype]
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, size = 10, color = "black"),
    axis.text.y = element_text(size = 10, color = "black"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]], nrow = 2)

p <- list()
for (celltype in celltypes) {
  
  df <- readRDS(paste0(folder_ect_summary, celltype, "_ECT_summary_EAS_SLEremoved.RDS"))
  
  # Convert mbe_pval_reverse_pair to numeric if it’s stored as character
  df <- df %>%
    mutate(mbe_pval_reverse_pair = suppressWarnings(as.numeric(mbe_pval_reverse_pair)))
  
  # Keep only FDR-significant pairs
  df_sig <- df %>%
    dplyr::filter(ECT_FDR_5suppSNP < FDRcutoff)
  
  # Fix naming if needed
  df_sig$trait[df_sig$trait == "asthma_pmid36778051"] <- "asthma-pmid36778051"
  
  # Summarize counts per trait
  df_summary <- df_sig %>%
    group_by(trait) %>%
    summarise(
      n_sig_pairs = n(),
      n_mbe_sig = sum(!is.na(mbe_pval_reverse_pair) & mbe_pval_reverse_pair < MBEcutoff)
    ) %>%
    # Keep traits with at least one FDR-significant pair
    dplyr::filter(n_sig_pairs >= 1) %>%
    mutate(
      trait_simple = sub("-.*", "", trait)
    ) %>%
    arrange(desc(n_sig_pairs))
  
  
  p[[celltype]] <- ggplot(df_summary, aes(x = reorder(trait_simple, -n_sig_pairs))) +
    geom_bar(aes(y = n_sig_pairs), stat = "identity", fill = "grey80", color = "black", width = 0.7) +
    geom_bar(aes(y = n_mbe_sig), stat = "identity", fill = "darkturquoise", width = 0.7) +
    geom_text(aes(y = n_mbe_sig, label = n_mbe_sig), vjust = -0.4, size = 3.5) +
    labs(
      x = "Trait",
      y = paste0("# of FDR<", FDRcutoff, " (blue: MBE p<", MBEcutoff, ")"),
      title = types[celltype]
    ) +
    theme_bw(base_size = 14) +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 90, hjust = 0, size = 10, color = "black"),
      axis.text.y = element_text(size = 10, color = "black"),
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
    )
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]], nrow = 2, top = "Number of pairs with MBE p < 0.05, for the sig pairs")
```



### ECT FDR < 0.2

```{r fig.height=6, fig.width=12, warning=F, message=F}

FDRcutoff <- 0.2
MBEcutoff <- 0.05

p <- list()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EAS_SLEremoved.RDS"))
  
  df_summary <- df %>%
    group_by(trait) %>%
    summarise(
      n_sig_FDR_3suppSNP = sum(ECT_FDR_5suppSNP < FDRcutoff, na.rm = TRUE)
    ) %>%
    arrange(desc(n_sig_FDR_3suppSNP))
  
  df_summary$trait[df_summary$trait =="asthma_pmid36778051"] <- "asthma-pmid36778051"
  
  df_summary <- df_summary %>%
    mutate(trait_simple = sub("-.*", "", trait))
  
  p[[celltype]] <- ggplot(df_summary, aes(x = reorder(trait_simple, -n_sig_FDR_3suppSNP),
                       y = n_sig_FDR_3suppSNP,
                       fill = n_sig_FDR_3suppSNP)) +
  geom_bar(stat = "identity", width = 0.7, color = "black") +
  scale_fill_gradient(low = "lightblue", high = "steelblue") +
  labs(
    x = "Trait",
    y = paste0("# of pairs at FDR < ", FDRcutoff),
    title = types[celltype]
  ) +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, size = 10, color = "black"),
    axis.text.y = element_text(size = 10, color = "black"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]], nrow = 2)

p <- list()
for (celltype in celltypes) {
  
  df <- readRDS(paste0(folder_ect_summary, celltype, "_ECT_summary_EAS_SLEremoved.RDS"))
  
  # Convert mbe_pval_reverse_pair to numeric if it’s stored as character
  df <- df %>%
    mutate(mbe_pval_reverse_pair = suppressWarnings(as.numeric(mbe_pval_reverse_pair)))
  
  # Keep only FDR-significant pairs
  df_sig <- df %>%
    dplyr::filter(ECT_FDR_5suppSNP < FDRcutoff)
  
    # Fix naming if needed
  df_sig$trait[df_sig$trait == "asthma_pmid36778051"] <- "asthma-pmid36778051"
  
  # Summarize counts per trait
  df_summary <- df_sig %>%
    group_by(trait) %>%
    summarise(
      n_sig_pairs = n(),
      n_mbe_sig = sum(!is.na(mbe_pval_reverse_pair) & mbe_pval_reverse_pair < MBEcutoff)
    ) %>%
    # Keep traits with at least one FDR-significant pair
    dplyr::filter(n_sig_pairs >= 1) %>%
    mutate(
      trait_simple = sub("-.*", "", trait)
    ) %>%
    arrange(desc(n_sig_pairs))
  

  
  p[[celltype]] <- ggplot(df_summary, aes(x = reorder(trait_simple, -n_sig_pairs))) +
    geom_bar(aes(y = n_sig_pairs), stat = "identity", fill = "grey80", color = "black", width = 0.7) +
    geom_bar(aes(y = n_mbe_sig), stat = "identity", fill = "darkturquoise", width = 0.7) +
    geom_text(aes(y = n_mbe_sig, label = n_mbe_sig), vjust = -0.4, size = 3.5) +
    labs(
      x = "Trait",
      y = paste0("# of FDR<", FDRcutoff, " (blue: MBE p<", MBEcutoff, ")"),
      title = types[celltype]
    ) +
    theme_bw(base_size = 14) +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 90, hjust = 0, size = 10, color = "black"),
      axis.text.y = element_text(size = 10, color = "black"),
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
    )
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]],p[[6]], nrow = 2, top = "Number of pairs with MBE p < 0.05, for the sig pairs")
```




## Number of significant pairs at different cutoffs, for each cell type

```{r fig.height=3, fig.width=9, warning=F, message=F}

num_fdr01 <- c()
num_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EAS_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
  num_fdr01 <- c(num_fdr01, nrow(df_fdr01))
  
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2 & df$ECT_FDR_5suppSNP >= 0.1,]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]
  num_fdr02 <- c(num_fdr02, nrow(df_fdr02))
  
}

sum <- data.frame(celltype = types,
                  num_fdr01 = num_fdr01,
                  num_fdr02 = num_fdr02)


df <- sum %>%
  pivot_longer(cols = starts_with("num_fdr"), names_to = "event", values_to = "total") %>%
  mutate(
    event = recode(event,
                   "num_fdr01" = "FDR < 0.1",
                   "num_fdr02" = "0.1 < FDR < 0.2")
  )

df$event <- factor(df$event, levels = c("FDR < 0.1", "0.1 < FDR < 0.2"))

# Plot
p1 <- ggplot(df, aes(x = fct_inorder(celltype), y = total, fill = event)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), alpha = 0.9) +
  scale_fill_manual(
    name = "group",
    values = c("#F8766D", "darkturquoise"),
    labels = c("FDR < 0.1", "0.1 < FDR < 0.2")
  ) +
  geom_text(
    aes(label = total),
    position = position_dodge(width = 0.9),
    color = "black",
    size = 3,
    vjust = -0.3
  ) +
  labs(x = "Cell types", y = "Count") +
  ggtitle("# of pairs") +
  ylim(0, 60) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.text.x = element_text(size = 8, color = "black", angle = 45, hjust = 1, vjust = 1.1),
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, color = "black"),
    text = element_text(family = "Times")
  )

num_fdr01 <- c()
num_fdr02 <- c()
for (celltype in celltypes) {
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", 
                       celltype, "_ECT_summary_EAS_SLEremoved.RDS"))
  
  # Convert mbe_pval_reverse_pair to numeric safely (ignore "0/1snp" or NA)
  df$mbe_pval_reverse_pair <- suppressWarnings(as.numeric(df$mbe_pval_reverse_pair))
  df$mbe_pval_reverse_pair[is.na(df$mbe_pval_reverse_pair)] <- 0.5
  
  # --- FDR < 0.1 ---
  df_fdr01 <- df %>%
    dplyr::filter(
      ECT_FDR_5suppSNP < 0.1,
      !(mbe_pval_reverse_pair < MBEcutoff)  # remove reverse-causal pairs
    ) %>%
    dplyr::filter(!is.na(p_ECT))
  
  num_fdr01 <- c(num_fdr01, nrow(df_fdr01))
  
  # --- 0.1 < FDR < 0.2 ---
  df_fdr02 <- df %>%
    dplyr::filter(
      ECT_FDR_5suppSNP < 0.2,
      ECT_FDR_5suppSNP >= 0.1,
      !(mbe_pval_reverse_pair < MBEcutoff)
    ) %>%
    dplyr::filter(!is.na(p_ECT))
  
  num_fdr02 <- c(num_fdr02, nrow(df_fdr02))
}

# summary table
sum <- data.frame(
  celltype = types,
  num_fdr01 = num_fdr01,
  num_fdr02 = num_fdr02
)



df <- sum %>%
  pivot_longer(
    cols = starts_with("num_fdr"),
    names_to = "event",
    values_to = "total"
  ) %>%
  mutate(
    event = recode(event,
                   "num_fdr01" = "FDR < 0.1",
                   "num_fdr02" = "0.1 < FDR < 0.2")
  )

df$event <- factor(df$event, levels = c("FDR < 0.1",
                                        "0.1 < FDR < 0.2"))

# ---- Plot ----
p2 <- ggplot(df, aes(x = fct_inorder(celltype), y = total, fill = event)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), alpha = 0.9) +
  scale_fill_manual(
    name = "group",
    values = c("#F8766D", "darkturquoise"),
    labels = c("FDR < 0.1", "0.1 < FDR < 0.2")
  ) +
  geom_text(
    aes(label = total),
    position = position_dodge(width = 0.9),
    color = "black",
    size = 3,
    vjust = -0.3
  ) +
  labs(
    x = "Cell types",
    y = "Count (excluding MBE p < 0.05)",
    title = "# of pairs after removing reverse-causal signals"
  ) +
  ylim(0, 60) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.text.x = element_text(size = 8, color = "black", angle = 45, hjust = 1, vjust = 1.1),
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, color = "black"),
    text = element_text(family = "Times")
  )

all <- grid.arrange(p1, p2, nrow = 1)
```



## Traits and pathways identified

### height-ebi-a-GCST90018739

```{r fig.height=6, fig.width=12, warning=F, message=F}

trait <- "height-ebi-a-GCST90018739"

df_trait_fdr01 <- c()
df_trait_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EAS_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.1, ]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$ECT_FDR_5suppSNP),]
  df_trait_fdr01 <- rbind(df_trait_fdr01,df_fdr01)
  
  df_fdr02 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.2, ]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$ECT_FDR_5suppSNP),]
  df_trait_fdr02 <- rbind(df_trait_fdr02,df_fdr02)
  
}

df_trait_fdr01$celltype <- types[df_trait_fdr01$celltype]

# Prepare data
selected <- df_trait_fdr01 %>%
  dplyr::mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.1")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p



supp_snps_all <- readRDS("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/results/supp_snps_ECTFDR02.RDS")
supp_snps_trait <- supp_snps_all[supp_snps_all$trait == trait,]

supp_snps_trait <- supp_snps_trait[supp_snps_trait$factor %in% df_trait_fdr01$factor,]

DT::datatable(supp_snps_trait,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;',paste0("supporting snps for ", trait)),options = list(pageLength = 10) )

df_trait_fdr02$celltype <- types[df_trait_fdr02$celltype]

# Prepare data
selected <- df_trait_fdr02 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.2")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p
```






### MCV-ebi-a-GCST90018746

```{r fig.height=6, fig.width=12, warning=F, message=F}

trait <- "MCV-ebi-a-GCST90018746"

df_trait_fdr01 <- c()
df_trait_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_EAS_SLEremoved.RDS"))
  
  df_fdr01 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.1, ]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$ECT_FDR_5suppSNP),]
  df_trait_fdr01 <- rbind(df_trait_fdr01,df_fdr01)
  
  df_fdr02 <- df[df$trait == trait & df$ECT_FDR_5suppSNP< 0.2, ]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$ECT_FDR_5suppSNP),]
  df_trait_fdr02 <- rbind(df_trait_fdr02,df_fdr02)
  
}

df_trait_fdr01$celltype <- types[df_trait_fdr01$celltype]

# Prepare data
selected <- df_trait_fdr01 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.1")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p


df_trait_fdr02$celltype <- types[df_trait_fdr02$celltype]

# Prepare data
selected <- df_trait_fdr02 %>%
  mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.2")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p
```


## Plots for all pairs at ECT FDR < 0.1

### Plots

```{r fig.height=3, fig.width=7, warning=F, message=F}

# candidate_pairs <- data.frame(celltype = c("B_cell","B_cell","CD14_positive_monocyte","thymocyte","thymocyte","thymocyte","thymocyte"),
#                               trait = c("Psoriasis-ebi-a-GCST90038681","RA-ukb-a-105","SLE-ebi-a-GCST90018917","SLE-ebi-a-GCST90018917",
#                                         "SLE-ebi-a-GCST90018917","IBD-ebi-a-GCST003043","IBD-ebi-a-GCST003043"),
#                               factor = c("04062_PC2","04071_PC4","04120_PC1","04015_PC2","04022_PC4","00230_PC2","04924_PC1")
#                               )

fdr_cutoff <- 0.2
df_all_fdr01$celltype <- celltypes[df_all_fdr01$celltype]

for (i in 1:nrow(df_all_fdr01)){
  
  celltype <- df_all_fdr01$celltype[i]
  trait <- df_all_fdr01$trait[i]
  factor <- df_all_fdr01$factor[i]
  
  file_harmo <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/assoc_harmonize/",celltype, "-", trait, "_harmo.RDS")
  dt_harmo <- readRDS(file_harmo)
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/ECT_summary_final/", celltype,"_ECT_summary_EAS_SLEremoved.RDS"))
  
  dat <- dt_harmo[[factor]]
  snp_select <- dat[dat$FDR.exposure < fdr_cutoff,]
  snp_select$chr <- as.numeric(as.character(snp_select$chr.exposure))
  snp_select$chr <- factor(snp_select$chr, levels = sort(unique(snp_select$chr)))
  
  fit <- lm(snp_select$beta.outcome ~ 0 + snp_select$beta.exposure)
  
  ect_p <- df$p_ECT[df$factor == factor & df$trait ==trait]
  
  pathwayname <- df$pathwayName[df$factor == factor & df$trait ==trait]
  
  eff <- ggplot(snp_select, aes(x=beta.exposure, y=beta.outcome, color=chr)) +
    geom_point(size = 4) + 
    geom_errorbar(aes(ymin=beta.outcome-se.outcome, ymax=beta.outcome+se.outcome, color=chr), width=0.01, alpha=0.6) +
    theme_bw(base_line_size = 0.3) +
    theme(axis.title.x = element_text(size = 16),
          axis.text.x = element_text(size = 14, color = "black"),
          axis.title.y = element_text(size =16),
          axis.text.y = element_text(size = 14, color = "black"),
          text= element_text(family="Times"),
          legend.text = element_text(size=12),
          legend.title = element_text(size=12)) + 
    geom_abline(slope = coef(fit)[1], intercept = 0, color = "grey", size = 0.5) +
    geom_label(aes(x = Inf, y = Inf), hjust = 1, vjust = 1,
               label = paste("R^2 = ", signif(summary(fit)$r.squared, 3), 
                             "\nECT p-value =", ect_p),
               color = "black", family = "Times", size =3, label.size = NA,fill=NA) +
    xlab(expression(hat(beta)[factor])) + 
    ylab(expression(hat(beta)[gwas])) +
    geom_vline(xintercept = 0, color = "grey", linetype = "dashed") +
    geom_hline(yintercept = 0, color = "grey", linetype = "dashed")
  
  
  #snp_select <- dat[dat$FDR.exposure > fdr_cutoff & dat$steiger_dir ==T,]
  snp_select <- dat[dat$FDR.exposure > fdr_cutoff,]
  
  fit <- lm(snp_select$beta.outcome ~ 0 + snp_select$beta.exposure)
  coef <- summary(fit)
  p <- round(coef$coefficients[,4], digits = 4)
  #ect_p <- df$p_ECT[df$factor == factor & df$trait ==trait]
  
  eff_rev <- ggplot(snp_select, aes(x=beta.exposure, y=beta.outcome)) +
    geom_point(size = 4, color ="steelblue") + 
    theme_bw(base_line_size = 0.3) +
    theme(axis.title.x = element_text(size = 16),
          axis.text.x = element_text(size = 14, color = "black"),
          axis.title.y = element_text(size =16),
          axis.text.y = element_text(size = 14, color = "black"),
          text= element_text(family="Times"),
          legend.text = element_text(size=12),
          legend.title = element_text(size=12)) + 
    geom_abline(slope = coef(fit)[1], intercept = 0, color = "grey", size = 0.5) +
    geom_label(aes(x = Inf, y = Inf), hjust = 1, vjust = 1,
               label = paste("R^2 = ", signif(summary(fit)$r.squared, 3), 
                             "\n p-value =", p),
               color = "black", family = "Times", size =3, label.size = NA,fill=NA) +
    xlab(expression(hat(beta)[factor])) + 
    ylab(expression(hat(beta)[gwas])) +
    geom_vline(xintercept = 0, color = "grey", linetype = "dashed") +
    geom_hline(yintercept = 0, color = "grey", linetype = "dashed")
  

  
  file_gene_loading <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_v2/gene_loading/",celltype, "_", factor, "-", trait, ".RDS")
  gene_loadings_pc <- readRDS(file_gene_loading)
  
  gene_loadings_pc_abs <- abs(gene_loadings_pc)
  gene_loadings_pc_abs_sort <- sort(gene_loadings_pc_abs,decreasing = T)
  topgenes <- names(gene_loadings_pc_abs_sort)[1:10]
  
  gene_loadings_pc <- as.data.frame(cbind(names(gene_loadings_pc),gene_loadings_pc))
  names(gene_loadings_pc) <- c("gene_name","gene_loadings_pc")
  
  # Extract gene information based on the gene symbol
  gene_info <- genes(EnsDb.Hsapiens.v75, filter = ~ gene_name ==  gene_loadings_pc$gene_name)
  gene_info <- as.data.frame(gene_info)
  gene_info <- gene_info[!duplicated(gene_info$gene_name),]
  
  gene_info <- merge(gene_info,gene_loadings_pc, by="gene_name")
  gene_info <- gene_info[gene_info$seqnames %in%c(1:22),]
  
  loading_plot <- gene_info[,c("seqnames","start","gene_name","gene_loadings_pc")]
  colnames(loading_plot) <- c("chromosome_name","start_position","gene_name","loadings")
  loading_plot$loadings <- round(as.numeric(loading_plot$loadings),digits = 4)
  
  don <- loading_plot %>%
    
    # Compute chromosome size
    group_by(chromosome_name) %>%
    summarise(chr_len=max(start_position)) %>%
    
    # Calculate cumulative position of each chromosome
    mutate(tot=cumsum(as.numeric(chr_len))-as.numeric(chr_len)) %>%
    dplyr::select(-chr_len) %>%
    
    # Add this info to the initial dataset
    left_join(loading_plot, ., by=c("chromosome_name"="chromosome_name")) %>%
    
    # Add a cumulative position of each SNP
    arrange(chromosome_name, start_position) %>%
    mutate( start_positioncum=start_position+tot) %>%
    
    # Add highlight and annotation information
    #mutate( is_annotate=ifelse(gene_name %in% loading_plot_top10$gene_name, "yes", "no"))
    mutate( is_annotate=ifelse(gene_name %in% topgenes, "yes", "no"))
  # Then we need to prepare the X axis. Indeed we do not want to display the cumulative position of SNP in bp, but just show the chromosome name instead.
  axisdf = don %>% group_by(chromosome_name) %>% summarize(center=( max(start_positioncum) + min(start_positioncum) ) / 2 )
  
  manhplot_gene <- ggplot(don, aes(x=start_positioncum, y=loadings)) +
    
    # Show all points
    #rasterise(geom_point( aes(color=as.factor(chromosome_name)), alpha=0.8, size=3),dpi=80 )+
    geom_point( aes(color=as.factor(chromosome_name)), alpha=0.8, size=3) +
    scale_color_manual(values = rep(c("red", "steelblue"), 22)) +
    
    # custom X axis:
    scale_x_continuous( label = as.integer(axisdf$chromosome_name), breaks= axisdf$center ) +
    #scale_y_continuous(expand = c(0, 0) ) +     # remove space between plot area and x axis
    
    #ylab(expression(paste("-log"[10],"(p-value)"))) +
    #ylim(0,max(-log10(don$loadings)) + 2) +
    #ylim(min(as.numeric(don$loadings)),max(as.numeric(don$loadings))) +
    #ylab("") +
    ylab("Gene Loadings") +
    xlab("Chromosome") +
    
    # Custom the theme:
    theme_bw() +
    #ggtitle(i) + theme(plot.title = element_text(hjust = 0.5)) +
    theme(
      legend.position="none",
      panel.border = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      axis.title.x = element_text(size = 18),
      axis.text.x = element_text(size = 16, color = "black"),
      axis.title.y = element_text(size = 18),
      axis.text.y = element_text(size = 16, color = "black"),
      text= element_text(family="Times"),
      #axis.text.y=element_blank(),
      #axis.ticks.y=element_blank()
    ) +
    geom_label_repel( data=subset(don, is_annotate=="yes"), aes(label=gene_name), size=4)
  
    
    cat(paste0(celltype,"-", pathwayname, "-", trait ))
  
  
    all <- grid.arrange(eff, eff_rev, nrow = 1)
    
    print(manhplot_gene)
    print(paste0("Top 10 genes with largest abs loading: ", paste0(topgenes, collapse = ",")))
  
}

```

<!-- ### Gene function on the cell types , nots from chatgpt  -->

