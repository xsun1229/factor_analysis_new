---
title: "ACAT"
author: "XSun"
date: "2023-12-06"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

```{r }
suppressMessages(library(ggplot2))
suppressMessages(library(gridExtra))
suppressMessages(library(tidyr))
suppressMessages(library(forcats))

celltypes <- c("B_cell","CD14_positive_monocyte","CD15_positive_leukocyte","platelet","T_cell","thymocyte")
type <- c("B cell (CD19+)","Monocyte (CD14+)","Leukocyte (CD15+)","Platelet","T cell (CD4+)","T cell (CD8+)")

```

# Origin ACAT p-values

```{r}

folder_acat <- "/project/xinhe/xsun/pathway_factor/analysis/2.ACAT/results/"

p1 <- list()
for (i in 1:length(celltypes)) {
  
  file_acat <- paste0(folder_acat,celltypes[i],"_real_acat.rdata")
  load(file_acat)
  
  p <- as.data.frame(unlist(acat_celltype))
  colnames(p) <- "p"
  p1[[i]] <-  ggplot(p, aes(x=p)) + geom_histogram(breaks = seq(0, 1, by = 0.05),color="white",fill = "steelblue")+ 
    theme_bw(base_line_size =0.3) +
    ggtitle(type[i]) + theme(plot.title = element_text(hjust = 0.5)) +
    labs(x = "ACAT p-values from real data",
         y = "Count") +
    
    theme(axis.title.x = element_text(size = 14),
          axis.text.x = element_text(size = 12, color = "black"),
          axis.title.y = element_text(size = 14),
          axis.text.y = element_text(size = 12, color = "black"),
          text= element_text(family="Times")) 
  
  
}

all1 <- grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]], nrow = 2)

p1 <- list()
for (i in 1:length(celltypes)) {
  
  file_acat <- paste0(folder_acat,celltypes[i],"_real_acat.rdata")
  load(file_acat)
  
  p <- as.data.frame(unlist(acat_celltype))
  colnames(p) <- "p"
  
  plotdata <- data.frame(observed = -log10(sort(as.numeric(as.character(p$p)))),
                       expected = -log10(ppoints(nrow(p))))
 

  p1[[i]] <- ggplot(plotdata) + theme_bw(base_line_size =0.3) +
    geom_point(aes(expected, observed), shape = 1, size = 1.5,color = "steelblue") +
    geom_abline(intercept = 0, slope = 1, alpha = 0.6, color = "red") +
    ggtitle(type[i]) + theme(plot.title = element_text(hjust = 0.5)) +
    labs(x = expression(paste("Expected -log"[10],"(p-value)")),
       y = expression(paste("Observed -log"[10],"(p-value)"))) +
  
    theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, color = "black"),
        text= element_text(family="Times")) 
  
  
}

all1 <- grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]], nrow = 2)

```



# corrected ACAT p-values

We sampled the SNPs 100 times, matching the number of SNP in LD & MAF using vSampler. Then we used the random SNPs the do the factor ~ SNP association tests and compute the acat p-values for each pair. We used these random acat p-values to correct the origin ACAT p-values. 

If we corrected the ACAT p-values within each pair, we have: 

(the lowest p-value = 0+1/100+1)

```{r}

folder_acat <- "/project/xinhe/xsun/pathway_factor/analysis/2.ACAT/results/"

p1 <- list()
for (i in 1:length(celltypes)) {
  
  file_acat <- paste0(folder_acat,celltypes[i],"_corrected_acat.rdata")
  load(file_acat)
  
  p <- as.data.frame(unlist(acat_p_corrected))
  colnames(p) <- "p"
  p1[[i]] <-  ggplot(p, aes(x=p)) + geom_histogram(breaks = seq(0, 1, by = 0.05),color="white",fill = "steelblue")+ 
    theme_bw(base_line_size =0.3) +
    ggtitle(type[i]) + theme(plot.title = element_text(hjust = 0.5)) +
    labs(x = "Corrected ACAT p-values",
         y = "Count") +
    
    theme(axis.title.x = element_text(size = 14),
          axis.text.x = element_text(size = 12, color = "black"),
          axis.title.y = element_text(size = 14),
          axis.text.y = element_text(size = 12, color = "black"),
          text= element_text(family="Times")) 
  
  
}

all1 <- grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]], nrow = 2)

p1 <- list()
for (i in 1:length(celltypes)) {
  
  file_acat <- paste0(folder_acat,celltypes[i],"_corrected_acat.rdata")
  load(file_acat)
  
  p <- as.data.frame(unlist(acat_p_corrected))
  colnames(p) <- "p"
  
  plotdata <- data.frame(observed = -log10(sort(as.numeric(as.character(p$p)))),
                       expected = -log10(ppoints(nrow(p))))
 

  p1[[i]] <- ggplot(plotdata) + theme_bw(base_line_size =0.3) +
    geom_point(aes(expected, observed), shape = 1, size = 1.5,color = "steelblue") +
    geom_abline(intercept = 0, slope = 1, alpha = 0.6, color = "red") +
    ggtitle(type[i]) + theme(plot.title = element_text(hjust = 0.5)) +
    labs(x = expression(paste("Expected -log"[10],"(p-value)")),
       y = expression(paste("Observed -log"[10],"(p-value)"))) +
  
    theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, color = "black"),
        text= element_text(family="Times")) 
  
  
}

all1 <- grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]], nrow = 2)

```

If we corrected the ACAT p-values within each cell type (pool all ACAT p-values in each cell type), we have: 

(the lowest p-value = 0+1/(total pair * 100)+1)


```{r}

folder_acat <- "/project/xinhe/xsun/pathway_factor/analysis/2.ACAT/results/"

p1 <- list()
for (i in 1:length(celltypes)) {
  
  file_acat <- paste0(folder_acat,celltypes[i],"_corrected_acat_pool_celltype.rdata")
  load(file_acat)
  
  p <- as.data.frame(unlist(acat_p_corrected))
  colnames(p) <- "p"
  p1[[i]] <-  ggplot(p, aes(x=p)) + geom_histogram(breaks = seq(0, 1, by = 0.05),color="white",fill = "steelblue")+ 
    theme_bw(base_line_size =0.3) +
    ggtitle(type[i]) + theme(plot.title = element_text(hjust = 0.5)) +
    labs(x = "Corrected ACAT p-values",
         y = "Count") +
    
    theme(axis.title.x = element_text(size = 14),
          axis.text.x = element_text(size = 12, color = "black"),
          axis.title.y = element_text(size = 14),
          axis.text.y = element_text(size = 12, color = "black"),
          text= element_text(family="Times")) 
  
  
}

all1 <- grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]], nrow = 2)

p1 <- list()
for (i in 1:length(celltypes)) {
  
  file_acat <- paste0(folder_acat,celltypes[i],"_corrected_acat_pool_celltype.rdata")
  load(file_acat)
  
  p <- as.data.frame(unlist(acat_p_corrected))
  colnames(p) <- "p"
  
  plotdata <- data.frame(observed = -log10(sort(as.numeric(as.character(p$p)))),
                       expected = -log10(ppoints(nrow(p))))
 

  p1[[i]] <- ggplot(plotdata) + theme_bw(base_line_size =0.3) +
    geom_point(aes(expected, observed), shape = 1, size = 1.5,color = "steelblue") +
    geom_abline(intercept = 0, slope = 1, alpha = 0.6, color = "red") +
    ggtitle(type[i]) + theme(plot.title = element_text(hjust = 0.5)) +
    labs(x = expression(paste("Expected -log"[10],"(p-value)")),
       y = expression(paste("Observed -log"[10],"(p-value)"))) +
  
    theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, color = "black"),
        text= element_text(family="Times")) 
  
  
}

all1 <- grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]], nrow = 2)

```


# Histogram for Storey's pi1 computed from ACAT p-values

## Origin p-values

```{r} 

load("/project/xinhe/xsun/pathway_factor/analysis/2.ACAT/results/story_real_acat.rdata")

values <- pi1_all
#labels <- c('CD19+', 'CD14+', 'CD15+', 'PLT', 'CD4+', 'CD8+')
#labels <- names(pi1_all)
labels <- c("B cell \n(CD19+)","Monocyte \n(CD14+)","Leukocyte \n(CD15+)","Platelet","T cell \n(CD4+)","T cell \n(CD8+)")
data <- data.frame(labels, values)

# Create the bar plot
p <- ggplot(data, aes(x=labels, y=values, fill=labels)) +
  geom_bar(stat="identity", color="steelblue", fill="steelblue") +
  labs(x="Cell Types", y="Storey's Pi1 for origin acat p-values") +
  theme_minimal()  +
  
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12, color = "black", angle = 45, hjust = 1,vjust = 1.1),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, color = "black"),
        text= element_text(family="Times")) 

p
```



## Corrected p-values

If we corrected the ACAT p-values within each pair


```{r} 

load("/project/xinhe/xsun/pathway_factor/analysis/2.ACAT/results/story_corrected_acat.rdata")

values <- pi1_all
#labels <- c('CD19+', 'CD14+', 'CD15+', 'PLT', 'CD4+', 'CD8+')
#labels <- names(pi1_all)
labels <- c("B cell \n(CD19+)","Monocyte \n(CD14+)","Leukocyte \n(CD15+)","Platelet","T cell \n(CD4+)","T cell \n(CD8+)")
data <- data.frame(labels, values)

# Create the bar plot
p <- ggplot(data, aes(x=labels, y=values, fill=labels)) +
  geom_bar(stat="identity", color="steelblue", fill="steelblue") +
  labs(x="Cell Types", y="Storey's Pi1 for corrected acat p-values") +
  theme_minimal()  +
  
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12, color = "black", angle = 45, hjust = 1,vjust = 1.1),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, color = "black"),
        text= element_text(family="Times")) 

p
```

If we corrected the ACAT p-values within each cell type (pool all ACAT p-values in each cell type)


```{r} 

load("/project/xinhe/xsun/pathway_factor/analysis/2.ACAT/results/story_corrected_acat_pool_celltype.rdata")

values <- pi1_all
#labels <- c('CD19+', 'CD14+', 'CD15+', 'PLT', 'CD4+', 'CD8+')
#labels <- names(pi1_all)
labels <- c("B cell \n(CD19+)","Monocyte \n(CD14+)","Leukocyte \n(CD15+)","Platelet","T cell \n(CD4+)","T cell \n(CD8+)")
data <- data.frame(labels, values)

# Create the bar plot
p <- ggplot(data, aes(x=labels, y=values, fill=labels)) +
  geom_bar(stat="identity", color="steelblue", fill="steelblue") +
  labs(x="Cell Types", y="Storey's Pi1 for corrected acat p-values") +
  theme_minimal()  +
  
  theme(axis.title.x = element_text(size = 14),
        axis.text.x = element_text(size = 12, color = "black", angle = 45, hjust = 1,vjust = 1.1),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, color = "black"),
        text= element_text(family="Times")) 

p
```