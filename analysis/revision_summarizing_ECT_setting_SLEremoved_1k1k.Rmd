---
title: "Summarizing ECT results -- ≥ 5 supporting SNPs & ≥ 20 genes, Onek1k"
author: "XSun"
date: "2025-12-09"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---


We applied cutoffs of 
+
- `supporting SNP ≥ 5` and 
- `gene number in pathway ≥ 20` 

to filter the pairs before performing FDR control. All results presented below are based on this setting.


```{r warning=F, message=F}
library(dplyr)
library(ggplot2)
library(gridExtra)
library(forcats)
library(tidyr)

library(ensembldb)
library(EnsDb.Hsapiens.v75)
library(ggrepel)
library(ggrastr)

celltypes <- c("B_cell","CD14_positive_monocyte","platelet","T_cell","thymocyte")
types <- c("B cell (CD19+)","Monocyte (CD14+)","Platelet","T cell (CD4+)","T cell (CD8+)")
names(celltypes) <- types
names(types) <- celltypes

source("/project/xinhe/xsun/pathway_factor/data_v2/traits_finalselection_SLEremoved.R")

folder_ect_summary <- "/project/xinhe/xsun/pathway_factor/analysis/1.ECT_1k1k/ECT_summary/"

```


# Overview of the expression data and expression factors


```{r fig.height=3, fig.width=9, warning=F, message=F}

summary <- c()
for (celltype in celltypes){
  
  expr <- readRDS(paste0("/project/xinhe/xsun/data/onek1k/expr/expr_normalized_grouped/", celltype, "_pseudobulk.rds"))
  n_gene <- nrow(expr)
  
  factors <- data.table::fread(paste0("/project/xinhe/xsun/pathway_factor/data_1k1k/expr_phefiles/20genes/all_pathways_pcs_", celltype, ".phen"))
  n_factors <- ncol(factors) - 2
  
  tmp <- c(celltype, n_gene, n_factors)
  summary <- rbind(summary,tmp)
}

summary <- as.data.frame(summary)
colnames(summary) <- c("Celltype","n_genes_expressed","n_expr_factors")
rownames(summary) <- NULL

summary$Celltype <- types[summary$Celltype]

DT::datatable(summary,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Number of genes expressed and number of expression factors'),options = list(pageLength = 10) )
```




# Number of supporting variants

```{r fig.height=6, fig.width=9, warning=F, message=F}

p <- list()
for(celltype in celltypes){
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_1k1k/ECT_summary/", celltype,"_ECT_summary_poolalltraits_selected.RDS"))
  df <- df[df$trait_id %in% traits_EUR,]
  
  summary <- df %>%
    count(num_supp_SNP, name = "Freq")
  
  # Plot
  p[[celltype]] <- ggplot(summary, aes(x = num_supp_SNP, y = Freq)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme_bw(base_line_size = 0.3) +
    ggtitle(types[celltype]) +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(x = "# of supporting SNPs in each pair", y = "# of factor–trait pairs") +
    geom_text(
      aes(label = ifelse(num_supp_SNP %% 5 == 0, as.character(Freq), "")),
      colour = "black", size = 2, vjust = -0.1, family = "Times"
    ) +
    annotate(
      geom = "text",
      x = Inf, y = Inf,
      label = paste0("# of candidate pairs = ", sum(summary$Freq[summary$num_supp_SNP >= 5])),
      hjust = 1.1, vjust = 1.5, size = 3, family = "Times", color = "black"
    ) +
    theme(
      axis.title.x = element_text(size = 10),
      axis.text.x  = element_text(size = 8, color = "black"),
      axis.title.y = element_text(size = 10),
      axis.text.y  = element_text(size = 8, color = "black"),
      text = element_text(family = "Times")
    ) +
    scale_x_continuous(breaks = seq(0, max(summary$num_supp_SNP), 5))
  
}


all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]], nrow = 2)

```


# Histogram for ECT p-values

```{r fig.height=6, fig.width=9, warning=F, message=F}

p <- list()
for(celltype in celltypes){
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_1k1k/ECT_summary/", celltype,"_ECT_summary_poolalltraits_selected.RDS"))
  df <- df[df$trait_id %in% traits_EUR,]
  
  df <- df[complete.cases(df$p_ECT),]
  
  summary_p <- df %>%
    mutate(bin = cut(p_ECT, breaks = seq(0, 1, by = 0.05), include.lowest = TRUE)) %>%
    count(bin, name = "Freq")
  
  # Correctly handle both [ and ( at the start of interval labels
  summary_p <- summary_p %>%
    mutate(
      bin_low  = as.numeric(sub("[^0-9\\.]*([0-9\\.]+),.*", "\\1", bin)),
      bin_high = as.numeric(sub(".*,([0-9\\.]+)\\]", "\\1", bin)),
      bin_mid  = (bin_low + bin_high) / 2
    )
  
  p[[celltype]] <- ggplot(summary_p, aes(x = bin_mid, y = Freq)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme_bw(base_line_size = 0.3) +
    ggtitle(types[celltype]) +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(x = "ECT p-value", y = "Count") +
    theme(
      axis.title.x = element_text(size = 10),
      axis.text.x  = element_text(size = 8, color = "black"),
      axis.title.y = element_text(size = 10),
      axis.text.y  = element_text(size = 8, color = "black"),
      text = element_text(family = "Times")
    ) +
    scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1))
  
}

all <- grid.arrange(p[[1]],p[[2]],p[[3]],p[[4]],p[[5]], nrow = 2)


```


# Number of significant pairs at different cutoffs, for each cell type

```{r fig.height=3, fig.width=4, warning=F, message=F}

num_fdr01 <- c()
num_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_poolalltraits_selected.RDS"))
  
  df_fdr01 <- df[df$ECT_FDR_5suppSNP < 0.1,]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$p_ECT),]
  num_fdr01 <- c(num_fdr01, nrow(df_fdr01))
  
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2 & df$ECT_FDR_5suppSNP >= 0.1,]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$p_ECT),]
  num_fdr02 <- c(num_fdr02, nrow(df_fdr02))
  
}

sum <- data.frame(celltype = types,
                  num_fdr01 = num_fdr01,
                  num_fdr02 = num_fdr02)


df <- sum %>%
  pivot_longer(cols = starts_with("num_fdr"), names_to = "event", values_to = "total") %>%
  mutate(
    event = recode(event,
                   "num_fdr01" = "FDR < 0.1",
                   "num_fdr02" = "0.1 < FDR < 0.2")
  )

df$event <- factor(df$event, levels = c("FDR < 0.1", "0.1 < FDR < 0.2"))

# Plot
p1 <- ggplot(df, aes(x = fct_inorder(celltype), y = total, fill = event)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), alpha = 0.9) +
  scale_fill_manual(
    name = "group",
    values = c("#F8766D", "darkturquoise"),
    labels = c("FDR < 0.1", "0.1 < FDR < 0.2")
  ) +
  geom_text(
    aes(label = total),
    position = position_dodge(width = 0.9),
    color = "black",
    size = 3,
    vjust = -0.3
  ) +
  labs(x = "Cell types", y = "Count") +
  ggtitle("# of pairs") +
  ylim(0, 10) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.text.x = element_text(size = 8, color = "black", angle = 45, hjust = 1, vjust = 1.1),
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size = 12, color = "black"),
    text = element_text(family = "Times")
  )

p1
```



# Detailed results for all pairs at ECT FDR < 0.2

```{r fig.height=3, fig.width=9, warning=F, message=F}

df_all_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_1k1k/ECT_summary/", celltype,"_ECT_summary_poolalltraits_selected.RDS"))
  df <- df[complete.cases(df$ECT_FDR_5suppSNP),]
  
  df_fdr02 <- df[df$ECT_FDR_5suppSNP < 0.2,]
  df_all_fdr02 <- rbind(df_all_fdr02,df_fdr02)
  
}

rownames(df_all_fdr02) <- NULL

#df_all_fdr02$celltype <- types[df_all_fdr02$celltype]
df_all_fdr02 <- df_all_fdr02[order(df_all_fdr02$ECT_FDR_5suppSNP),]

df_all_fdr01 <- df_all_fdr02[df_all_fdr02$ECT_FDR_5suppSNP < 0.1,]

DT::datatable(df_all_fdr02,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Pairs with ECT FDR <= 0.2 '),options = list(pageLength = 10) )

```

Evidence for the pairs with ECT FDR < 0.1

| celltype       |  factor   |  pathwayName                                    |  trait_id                    |  trait_name                  |  num_supp_SNP |  p_ECT   |  ECT_FDR_5suppSNP | Cell type effect on pathway                                                                                                                                                 | Pathway effects on trait                                                                                                                                                                                                                     | cell type effects on trait                                                                                                                                                                                                                                                                                       |
|----------------|-----------|-------------------------------------------------|------------------------------|------------------------------|---------------|----------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| T cell (CD8+)  | 04145_PC4 | Phagosome                                       | MCH-ebi-a-GCST90002390       | Mean Corpuscular Hemoglobin  | 6             | 0.000094 | 0.062886          | CD8⁺ T cells are not part of phagosome biology.                                                                                                                             | weak indirect influence via iron recycling. Phagosome activity in macrophages regulates clearance of aged RBCs and iron recycling. This can influence systemic iron availability, but does not directly regulate hemoglobin content per RBC. | Indirect. CD8⁺ T cells do not regulate erythropoiesis or hemoglobin synthesis. Only severe inflammation (IFN-γ/TNF-α) can secondarily suppress RBC production and slightly impact MCH                                                                                                                            |
| B cell (CD19+) | 04514_PC5 | Cell adhesion molecules                         | WBC-ebi-a-GCST90002407       | White blood cell count       | 14            | 0.000262 | 0.0639275         | B cells express adhesion molecules (LFA-1, ICAM/VCAM partners, L-selectin) required for lymph node homing, germinal center entry, and interactions with T cells.            | CAMs control leukocyte adhesion, migration, and tissue trafficking. Increased adhesion or mobilization alters how many leukocytes remain in circulation.                                                                                     | Yes. B cells constitute one subset of lymphocytes, affecting total WBC counts by their abundance. They also produce cytokines that can influence myelopoiesis.                                                                                                                                                   |
| B cell (CD19+) | 04612_PC3 | Antigen processing and presentation             | WBC-ebi-a-GCST90002407       | White blood cell count       | 14            | 0.000455 | 0.0639275         | B cells are professional MHC-II antigen-presenting cells; they capture antigen via BCR, process it, and present peptides to CD4⁺ T cells.                                   | Antigen presentation activates T cells → cytokine release (IL-2, IL-6, GM-CSF) → stimulates myelopoiesis and systemic leukocyte expansion, especially during infection/autoimmunity.                                                         | Yes. B cells constitute one subset of lymphocytes, affecting total WBC counts by their abundance. They also produce cytokines that can influence myelopoiesis.                                                                                                                                                   |
| B cell (CD19+) | 04213_PC5 | Longevity regulating pathway - multiple species | Psoriasis-ebi-a-GCST90038681 | Psoriasis                    | 5             | 0.0012   | 0.08429298        | Pathway includes mTOR, AMPK, FOXO, and insulin signaling, which regulate B-cell metabolism, activation, proliferation, and survival, though not B-cell–specific.            | Contains mTOR, AMPK, FOXO, insulin signaling components; these regulate keratinocyte proliferation and Th17/T-cell differentiation, which are central to psoriasis. Pathway is broad, not psoriasis-specific.                                | Contribute to psoriasis but are not the main pathogenic driver. Psoriasis is driven mainly by the IL-23/Th17 axis. B cells contribute via antigen presentation, autoantibody production, and cytokine secretion. Rituximab studies show mixed improvement/worsening → indicates modulatory but not central role. |
| B cell (CD19+) | 04672_PC3 | Intestinal immune network for IgA production    | WBC-ebi-a-GCST90002407       | White blood cell count       | 9             | 0.000923 | 0.08429298        | IgA class switching and IgA-secreting plasma cell generation occur in B cells in gut-associated lymphoid tissues; this pathway is fundamentally centered on B-cell biology. | IgA regulation affects mucosal immune homeostasis. Mucosal inflammation elevates systemic cytokines → enhances myelopoiesis and increases WBC. IgA deficiency/infection also elevate WBC.                                                    | Yes. B cells constitute one subset of lymphocytes, affecting total WBC counts by their abundance. They also produce cytokines that can influence myelopoiesis.                                                                                                                                                   |




# Traits and pathways identified -- WBC-ebi-a-GCST90002407

```{r fig.height=6, fig.width=12, warning=F, message=F}

trait <- "WBC-ebi-a-GCST90002407"

df_trait_fdr01 <- c()
df_trait_fdr02 <- c()
for(celltype in celltypes){
  
  df <- readRDS(paste0(folder_ect_summary, celltype,"_ECT_summary_poolalltraits_selected.RDS"))
  
  df_fdr01 <- df[df$trait_id == trait & df$ECT_FDR_5suppSNP< 0.1, ]
  df_fdr01 <- df_fdr01[complete.cases(df_fdr01$ECT_FDR_5suppSNP),]
  df_trait_fdr01 <- rbind(df_trait_fdr01,df_fdr01)
  
  df_fdr02 <- df[df$trait_id == trait & df$ECT_FDR_5suppSNP< 0.2, ]
  df_fdr02 <- df_fdr02[complete.cases(df_fdr02$ECT_FDR_5suppSNP),]
  df_trait_fdr02 <- rbind(df_trait_fdr02,df_fdr02)
  
}

# Prepare data
selected <- df_trait_fdr02 %>%
  dplyr::mutate(
    lgectpval = -log10(p_ECT),
    pathwayName = paste0(pathwayName," ",factor," ", celltype)
  )

# Plot
p <- ggplot(selected) +
  geom_col(
    aes(x = lgectpval, 
        y = reorder(pathwayName, lgectpval), 
        fill = celltype),
    width = 0.75
  ) +
  geom_text(
    aes(0, y = pathwayName, label = pathwayName),
    hjust = 0,
    nudge_x = 0.1,
    colour = "white",
    size = 4.5,
    family = "Times"
  ) +
  geom_text(
    aes(lgectpval, y = pathwayName, label = num_supp_SNP),
    hjust = 0,
    nudge_x = 0.05,
    colour = "black",
    size = 4.5,
    family = "Times"
  ) +
  labs(
    x = expression(paste("-log"[10], "(ECT p-value)")),
    y = NULL,
    title = paste0(unique(selected$trait)," ECT FDR < 0.2")
  ) +
  theme_bw(base_line_size = 0.3) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    text = element_text(family = "Times"),
    plot.title = element_text(hjust = 0.5)
  ) +
  xlim(0, 8)

p

```


- Roles of T cell CD 8+ in WBC

  - CD8⁺ T cells are one subtype of lymphocytes, and lymphocytes are one major component of the total WBC count.
  - Therefore, changes in CD8⁺ T-cell numbers (e.g., infection, immunosuppression, autoimmunity) will change the lymphocyte fraction and can shift the overall WBC count.
  - Beyond being part of the WBC composition, CD8⁺ T cells produce cytokines that shape hematopoiesis, which may influence neutrophils, monocytes, etc.

- Roles of B cell in WBC

1. Direct role (compositional)
  - B cells are one subtype of lymphocytes, which are a major component of the total WBC count.
  - If B-cell numbers increase or decrease, the total WBC count will change accordingly.

2. Indirect role (immune regulation)
  - B cells secrete cytokines (e.g., IL-6, IL-10) that can modulate myelopoiesis.
  - B-cell activation or depletion (e.g., rituximab) often leads to measurable shifts in circulating WBC subsets.

- Roles of pathways in WBC

  - Cell adhesion molecules, Antigen processing and presentation, Intestinal immune network for IgA production have been discussed above. 
  - Steroid hormone biosynthesis: 
      
The steroid hormone biosynthesis pathway produces:
  - Glucocorticoids (cortisol)
  - Mineralocorticoids
  - Sex hormones (estrogen, testosterone, progesterone)

Among these, glucocorticoids have strong, well-known effects on WBC count:

1. Glucocorticoids increase circulating neutrophils
  - They cause demargination, releasing neutrophils from vessel walls into the bloodstream. → WBC count rises, especially neutrophils.
2. Glucocorticoids decrease lymphocytes, eosinophils, and monocytes.
  - They induce lymphocyte apoptosis and redistribution.
  - They suppress eosinophils and monocytes.
3. Stress → increased endogenous cortisol → altered WBC
  - This is why stress, illness, or exogenous steroids (e.g., prednisone) raise WBC counts on labs.
4. Sex hormones also influence immunity. Although weaker than glucocorticoids:
  - Estrogen modulates lymphocyte activity
  - Testosterone is mildly immunosuppressive


# Plots for all pairs at ECT FDR < 0.1

```{r fig.height=3, fig.width=7, warning=F, message=F}

fdr_cutoff <- 0.2

#for (i in 1:1){
for (i in 1:nrow(df_all_fdr01)){
  
  celltype <- celltypes[df_all_fdr01$celltype[i]]
  trait <- df_all_fdr01$trait_id[i]
  factor <- df_all_fdr01$factor[i]
  
  file_harmo <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_1k1k/assoc_harmonize/",celltype, "-", trait, "_harmo.RDS")
  dt_harmo <- readRDS(file_harmo)
  
  df <- readRDS(paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_1k1k/ECT_summary/", celltype,"_ECT_summary_poolalltraits_selected.RDS"))
  
  dat <- dt_harmo[[factor]]
  snp_select <- dat[dat$FDR.exposure < fdr_cutoff,]
  snp_select$chr <- as.numeric(as.character(snp_select$chr.exposure))
  snp_select$chr <- factor(snp_select$chr, levels = sort(unique(snp_select$chr)))
  
  fit <- lm(snp_select$beta.outcome ~ 0 + snp_select$beta.exposure)
  
  ect_p <- df$p_ECT[df$factor == factor & df$trait ==trait]
  
  pathwayname <- df$pathwayName[df$factor == factor & df$trait ==trait]
  
  eff <- ggplot(snp_select, aes(x=beta.exposure, y=beta.outcome, color=chr)) +
    geom_point(size = 4) + 
    geom_errorbar(aes(ymin=beta.outcome-se.outcome, ymax=beta.outcome+se.outcome, color=chr), width=0.01, alpha=0.6) +
    theme_bw(base_line_size = 0.3) +
    theme(axis.title.x = element_text(size = 16),
          axis.text.x = element_text(size = 14, color = "black"),
          axis.title.y = element_text(size =16),
          axis.text.y = element_text(size = 14, color = "black"),
          text= element_text(family="Times"),
          legend.text = element_text(size=12),
          legend.title = element_text(size=12)) + 
    geom_abline(slope = coef(fit)[1], intercept = 0, color = "grey", size = 0.5) +
    geom_label(aes(x = Inf, y = Inf), hjust = 1, vjust = 1,
               label = paste("R^2 = ", signif(summary(fit)$r.squared, 3), 
                             "\nECT p-value =", ect_p),
               color = "black", family = "Times", size =3, label.size = NA,fill=NA) +
    xlab(expression(hat(beta)[factor])) + 
    ylab(expression(hat(beta)[gwas])) +
    geom_vline(xintercept = 0, color = "grey", linetype = "dashed") +
    geom_hline(yintercept = 0, color = "grey", linetype = "dashed")
  
  
  #snp_select <- dat[dat$FDR.exposure > fdr_cutoff & dat$steiger_dir ==T,]
  snp_select <- dat[dat$FDR.exposure > fdr_cutoff,]
  
  fit <- lm(snp_select$beta.exposure~ 0 + snp_select$beta.outcome)
  coef <- summary(fit)
  p <- round(coef$coefficients[,4], digits = 4)
  #ect_p <- df$p_ECT[df$factor == factor & df$trait ==trait]
  
  eff_rev <- ggplot(snp_select, aes(x=beta.outcome, y=beta.exposure)) +
    geom_point(size = 4, color ="steelblue") + 
    theme_bw(base_line_size = 0.3) +
    theme(axis.title.x = element_text(size = 16),
          axis.text.x = element_text(size = 14, color = "black"),
          axis.title.y = element_text(size =16),
          axis.text.y = element_text(size = 14, color = "black"),
          text= element_text(family="Times"),
          legend.text = element_text(size=12),
          legend.title = element_text(size=12)) + 
    geom_abline(slope = coef(fit)[1], intercept = 0, color = "grey", size = 0.5) +
    geom_label(aes(x = Inf, y = Inf), hjust = 1, vjust = 1,
               label = paste("R^2 = ", signif(summary(fit)$r.squared, 3), 
                             "\n p-value =", p),
               color = "black", family = "Times", size =3, label.size = NA,fill=NA) +
    xlab(expression(hat(beta)[gwas])) + 
    ylab(expression(hat(beta)[factor])) +
    geom_vline(xintercept = 0, color = "grey", linetype = "dashed") +
    geom_hline(yintercept = 0, color = "grey", linetype = "dashed")
  

  
  file_gene_loading <- paste0("/project/xinhe/xsun/pathway_factor/analysis/1.ECT_1k1k/gene_loading/",celltype, "_", factor, "-", trait, ".RDS")
  gene_loadings_pc <- readRDS(file_gene_loading)
  
  gene_loadings_pc_abs <- abs(gene_loadings_pc)
  gene_loadings_pc_abs_sort <- sort(gene_loadings_pc_abs,decreasing = T)
  topgenes <- names(gene_loadings_pc_abs_sort)[1:10]
  
  gene_loadings_pc <- as.data.frame(cbind(names(gene_loadings_pc),gene_loadings_pc))
  names(gene_loadings_pc) <- c("gene_name","gene_loadings_pc")
  
  # Extract gene information based on the gene symbol
  gene_info <- genes(EnsDb.Hsapiens.v75, filter = ~ gene_name ==  gene_loadings_pc$gene_name)
  gene_info <- as.data.frame(gene_info)
  gene_info <- gene_info[!duplicated(gene_info$gene_name),]
  
  gene_info <- merge(gene_info,gene_loadings_pc, by="gene_name")
  gene_info <- gene_info[gene_info$seqnames %in%c(1:22),]
  
  loading_plot <- gene_info[,c("seqnames","start","gene_name","gene_loadings_pc")]
  colnames(loading_plot) <- c("chromosome_name","start_position","gene_name","loadings")
  loading_plot$loadings <- round(as.numeric(loading_plot$loadings),digits = 4)
  
  don <- loading_plot %>%
    
    # Compute chromosome size
    group_by(chromosome_name) %>%
    summarise(chr_len=max(start_position)) %>%
    
    # Calculate cumulative position of each chromosome
    mutate(tot=cumsum(as.numeric(chr_len))-as.numeric(chr_len)) %>%
    dplyr::select(-chr_len) %>%
    
    # Add this info to the initial dataset
    left_join(loading_plot, ., by=c("chromosome_name"="chromosome_name")) %>%
    
    # Add a cumulative position of each SNP
    arrange(chromosome_name, start_position) %>%
    mutate( start_positioncum=start_position+tot) %>%
    
    # Add highlight and annotation information
    #mutate( is_annotate=ifelse(gene_name %in% loading_plot_top10$gene_name, "yes", "no"))
    mutate( is_annotate=ifelse(gene_name %in% topgenes, "yes", "no"))
  # Then we need to prepare the X axis. Indeed we do not want to display the cumulative position of SNP in bp, but just show the chromosome name instead.
  axisdf = don %>% group_by(chromosome_name) %>% summarize(center=( max(start_positioncum) + min(start_positioncum) ) / 2 )
  
  manhplot_gene <- ggplot(don, aes(x=start_positioncum, y=loadings)) +
    
    # Show all points
    #rasterise(geom_point( aes(color=as.factor(chromosome_name)), alpha=0.8, size=3),dpi=80 )+
    geom_point( aes(color=as.factor(chromosome_name)), alpha=0.8, size=3) +
    scale_color_manual(values = rep(c("red", "steelblue"), 22)) +
    
    # custom X axis:
    scale_x_continuous( label = as.integer(axisdf$chromosome_name), breaks= axisdf$center ) +
    #scale_y_continuous(expand = c(0, 0) ) +     # remove space between plot area and x axis
    
    #ylab(expression(paste("-log"[10],"(p-value)"))) +
    #ylim(0,max(-log10(don$loadings)) + 2) +
    #ylim(min(as.numeric(don$loadings)),max(as.numeric(don$loadings))) +
    #ylab("") +
    ylab("Gene Loadings") +
    xlab("Chromosome") +
    
    # Custom the theme:
    theme_bw() +
    #ggtitle(i) + theme(plot.title = element_text(hjust = 0.5)) +
    theme(
      legend.position="none",
      panel.border = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      axis.title.x = element_text(size = 18),
      axis.text.x = element_text(size = 16, color = "black"),
      axis.title.y = element_text(size = 18),
      axis.text.y = element_text(size = 16, color = "black"),
      text= element_text(family="Times"),
      #axis.text.y=element_blank(),
      #axis.ticks.y=element_blank()
    ) +
    geom_label_repel( data=subset(don, is_annotate=="yes"), aes(label=gene_name), size=4)
  
    
    cat(paste0(celltype,"-", pathwayname, "-", trait ))
  
  
    all <- grid.arrange(eff, eff_rev, nrow = 1)
    
    print(manhplot_gene)
    print(paste0("Top 10 genes with largest abs loading: ", paste0(topgenes, collapse = ",")))
  
}

```






